<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JAIRO Cloud ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨TSVç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
<style>
  /* ===== ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« ===== */
  body { font-family: sans-serif; margin: 20px; background: #f5f5f5; }
  h1 { color: #2c5f2e; font-size: 1.4em; margin-bottom: 16px; }

  /* ===== å…¥åŠ›ã‚¨ãƒªã‚¢ ===== */
  #input-area {
    background: white;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .input-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  .input-row label { font-weight: bold; white-space: nowrap; }
  #doi-input {
    width: 380px;
    padding: 8px;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  #pos-index-input {
    width: 200px;
    padding: 6px 8px;
    font-size: 0.9em;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* ===== ãƒœã‚¿ãƒ³ ===== */
  button { padding: 8px 20px; font-size: 1em; border: none; border-radius: 4px; cursor: pointer; }
  #fetch-btn { background: #2c5f2e; color: white; }
  #fetch-btn:hover { background: #1e4020; }
  #empty-btn { background: #546e7a; color: white; }
  #empty-btn:hover { background: #37474f; }

  /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»æƒ…å ±ãƒãƒ¼ ===== */
  #error-msg {
    color: #c62828;
    background: #ffebee;
    padding: 10px;
    border-radius: 4px;
    margin-top: 8px;
    display: none;
  }
  #loading { color: #555; margin-top: 8px; display: none; }
  #info-bar {
    display: none;
    margin-top: 10px;
    font-size: 0.92em;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  #info-bar a { font-weight: bold; color: #1565c0; word-break: break-all; }
  .oa-badge {
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.82em;
    font-weight: bold;
    color: white;
  }

  /* ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ ===== */
  #preview-area {
    display: none;
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  #preview-area h2 {
    background: #2c5f2e;
    color: white;
    margin: 0;
    padding: 12px 16px;
    font-size: 1em;
  }

  /* ===== ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ« ===== */
  #system-fields {
    padding: 12px 16px;
    border-bottom: 2px solid #e8f5e9;
  }
  #system-fields h3 {
    color: #1b5e20;
    font-size: 0.9em;
    margin: 0 0 8px 0;
    padding: 4px 8px;
    background: #c8e6c9;
    border-radius: 4px;
  }
  .sys-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82em;
  }
  .sys-table th {
    background: #e8f5e9;
    color: #2c5f2e;
    text-align: left;
    padding: 5px 8px;
    font-size: 0.82em;
  }
  .sys-table td {
    padding: 3px 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
  }
  .sys-table td:first-child { color: #444; width: 220px; white-space: nowrap; }
  .sys-table td:nth-child(2) { color: #777; width: 180px; font-size: 0.85em; }
  .sys-table input[type=text],
  .sys-table select {
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 3px 6px;
    font-size: 0.82em;
    font-family: sans-serif;
  }

  /* ===== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ã‚¨ãƒªã‚¢ ===== */
  #metadata-fields { padding: 8px 0; }

  /* ===== ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== */
  .field-section { border-bottom: 1px solid #e8f5e9; }

  .section-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    cursor: pointer;
    background: #f1f8e9;
    border-left: 4px solid #2c5f2e;
    user-select: none;
    font-size: 0.88em;
    font-weight: bold;
    color: #1b5e20;
  }
  .section-header:hover { background: #e8f5e9; }
  .section-header .toggle-icon { font-size: 0.8em; color: #555; flex-shrink: 0; }
  .section-header a { color: #1565c0; text-decoration: none; }
  .section-header a:hover { text-decoration: underline; }
  .section-header .summary {
    color: #666;
    font-weight: normal;
    font-size: 0.9em;
    display: none;
    margin-left: 4px;
  }

  .accordion-content { display: block; }

  /* ===== ãƒã‚¹ãƒˆé …ç›® ===== */
  .nested-item {
    margin: 4px 0;
  }

  /* Level 1 */
  .level-1 {
    margin-left: 16px;
    border-left: 3px solid #4caf50;
    padding-left: 8px;
  }
  /* Level 2 */
  .level-2 {
    margin-left: 32px;
    border-left: 3px solid #81c784;
    padding-left: 8px;
  }
  /* Level 3 */
  .level-3 {
    margin-left: 48px;
    border-left: 3px solid #a5d6a7;
    padding-left: 8px;
  }
  /* Level 4 */
  .level-4 {
    margin-left: 64px;
    border-left: 3px solid #c8e6c9;
    padding-left: 8px;
  }

  .item-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: #f9fbe7;
    border-radius: 4px;
    margin-bottom: 2px;
    font-size: 0.82em;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    user-select: none;
  }
  .item-header:hover { background: #f1f8e9; }
  .item-header .toggle-icon { font-size: 0.8em; color: #555; }
  .item-header .item-label { flex: 1; }
  .item-header .item-summary {
    color: #888;
    font-weight: normal;
    font-size: 0.9em;
    display: none;
  }

  .item-content { display: block; }

  /* ===== ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡Œ ===== */
  .field-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 8px;
    font-size: 0.82em;
    border-bottom: 1px solid #f5f5f5;
  }
  .field-row:hover { background: #fafff8; }
  .field-row .field-label {
    color: #555;
    white-space: nowrap;
    min-width: 180px;
    width: 220px;
    flex-shrink: 0;
    font-size: 0.92em;
  }
  .field-row input[type=text],
  .field-row textarea,
  .field-row select {
    flex: 1;
    box-sizing: border-box;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 3px 6px;
    font-size: 0.82em;
    font-family: sans-serif;
  }
  .field-row textarea { resize: vertical; min-height: 60px; }
  .field-row select { flex: 0 0 auto; width: auto; min-width: 120px; }

  /* ===== è¿½åŠ ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ ===== */
  .btn-add {
    background: #e8f5e9;
    color: #2c5f2e;
    border: 1px solid #a5d6a7;
    padding: 2px 10px;
    font-size: 0.78em;
    border-radius: 12px;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .btn-add:hover { background: #c8e6c9; }
  .btn-delete {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
    padding: 2px 10px;
    font-size: 0.78em;
    border-radius: 12px;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .btn-delete:hover { background: #ffcdd2; }

  /* ===== ã‚¨ãƒ³ãƒˆãƒªã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå§“åãƒ»è­˜åˆ¥å­ç­‰ã‚µãƒ–é…åˆ—1ä»¶ï¼‰ ===== */
  .entry-group {
    border-left: 2px solid #e0e0e0;
    margin: 4px 0 4px 16px;
    padding: 4px 0 4px 8px;
  }
  .btn-delete-inline {
    display: block;
    margin: 4px 0;
    font-size: 0.8em;
    padding: 2px 10px;
  }

  /* ===== ãƒã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆLevel 2+ï¼‰ ===== */
  .nested-section-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 8px;
    font-size: 0.82em;
    font-weight: bold;
    color: #444;
    cursor: pointer;
    user-select: none;
  }
  .nested-section-header:hover { background: #f9fbe7; }
  .nested-section-header .toggle-icon { font-size: 0.75em; color: #777; }
  .nested-section-content { display: block; }

  /* ===== è­¦å‘Šè¡¨ç¤º ===== */
  .warn-badge {
    color: #e65100;
    font-size: 0.75em;
    cursor: help;
    flex-shrink: 0;
  }

  /* ===== ãƒ¬ãƒ™ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ ===== */
  .level-icon { flex-shrink: 0; }

  /* ===== å‚ç…§å€¤ï¼ˆãƒ’ãƒ³ãƒˆï¼‰ã‚»ãƒ« ===== */
  .hint-cell {
    flex: 0 1 auto;
    max-width: 220px;
    color: #888;
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: #f8f8f4;
    padding: 2px 6px;
    border-radius: 3px;
    border: 1px dashed #ddd;
  }
  .hint-cell a { color: #1565c0; text-decoration: none; }
  .hint-cell a:hover { text-decoration: underline; }
</style>
</head>
<body>
<h1>ğŸŒ¾ JAIRO Cloud ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨TSVç”Ÿæˆãƒ„ãƒ¼ãƒ«(Î²)</h1>

<p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ãƒ™ãƒ¼ã‚¿ç‰ˆã§ã™ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨TSVãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆæ©Ÿèƒ½ã¯æœªå®Ÿè£…ã§ã™ã€‚</p>
<p>ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€Crossref APIãŠã‚ˆã³OpenAlex APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã¿å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
<p>ã€ŒDOIã€ã«DOIã‚’å…¥åŠ›ã—ã¦ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚</p>


<!-- ===== DOIå…¥åŠ›ã‚¨ãƒªã‚¢ ===== -->
<div id="input-area">
  <div class="input-row">
    <label>DOI:</label>
    <input type="text" id="doi-input" placeholder="ä¾‹: 10.1016/j.advnut.2025.100480" value="">
    <button id="fetch-btn" onclick="fetchData()">ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
    <button id="empty-btn" onclick="showEmptyFields()">ç©ºå€¤ã§å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º</button>
  </div>
  <div class="input-row">
    <label title="WEKOã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹IDï¼ˆ.pos_index[0]ï¼‰">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ID:</label>
    <input type="text" id="pos-index-input" value="1718256617194" placeholder="ä¾‹: 1718256617194">
    <span style="color:#888;font-size:0.85em">ï¼ˆ.pos_index[0] ã®å€¤ï¼‰</span>
  </div>
  <div id="loading" style="display:none">â³ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­ã§ã™ï¼ˆROR/ISNIã‚‚ä¸¦è¡Œå–å¾—ï¼‰...</div>
  <div id="apikey-warning" style="display:none; background:#fff8e1; border:1px solid #ffe082; color:#6d4c00; padding:8px 12px; border-radius:4px; margin-bottom:8px; font-size:0.9em;">âš  OpenAlex API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã—ãªã„å ´åˆã€åˆ©ç”¨å›æ•°ãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚</div>
  <div id="error-msg"></div>
  <div id="info-bar" style="display:none">
    <a id="doi-link" href="" target="_blank"></a>
    <span id="oa-badge" class="oa-badge"></span>
  </div>
</div>

<!-- ===== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== -->
<div id="preview-area">
  <h2>ğŸ“‹ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ»ç·¨é›†</h2>

  <!-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
  <div id="system-fields">
    <h3>ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç®¡ç†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰</h3>
    <table class="sys-table">
      <thead>
        <tr>
          <th>ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å</th>
          <th>å€™è£œå€¤</th>
          <th>å€¤ï¼ˆç·¨é›†å¯èƒ½ï¼‰</th>
        </tr>
      </thead>
      <tbody id="system-fields-body">
        <!-- JS ã§ç”Ÿæˆ -->
      </tbody>
    </table>
  </div>

  <!-- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
  <div id="metadata-fields">
    <!-- JS ã§ç”Ÿæˆ -->
  </div>
</div>

<script>
// ================================================================
// STEP 2: å®šæ•°ãƒ»ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å®šç¾©
// ================================================================

const CONFIG = {
    // OpenAlex APIã‚­ãƒ¼ï¼ˆå¿…é ˆï¼‰
    // https://openalex.org/settings/api ã‹ã‚‰ã”è‡ªèº«ã®ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    OpenAlex_API_KEY: "YOUR_OpenAlex_API_KEY",

    // CiNii APIã‚­ãƒ¼ï¼ˆä»»æ„ï¼‰
    // CiNiiã‚¦ã‚§ãƒ–API åˆ©ç”¨ç™»éŒ² https://support.nii.ac.jp/ja/cinii/api/developer ã§å–å¾—ã—ãŸã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    CiNii_API_KEY: "YOUR_CiNii_API_KEY",
};

// ===== é™¤å¤–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒªã‚¹ãƒˆ =====
const EXCLUDED_KEYS = new Set([
  'item_30002_apc5',                // APC
  'item_30002_dissertation_number30',
  'item_30002_degree_name31',
  'item_30002_degree_grantor33',
  'item_30002_heading36',
  'system_identifier_doi',
  'system_identifier_hdl',
  'system_identifier_uri',
  'system_file',
  'item_1698624004',  // ã‚«ã‚¿ãƒ­ã‚°
  'item_1698624001',  // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚·ãƒªãƒ¼ã‚º
  'item_1698624002',  // åŸæ–‡ã®è¨€èª
  'item_1698624003',  // å¤§ãã•
  'item_1698624008',  // æ—¥ä»˜ï¼ˆãƒªãƒ†ãƒ©ãƒ«ï¼‰
  'item_1698624009',  // æ‰€è”µæ©Ÿé–¢
  'item_1698624010',  // ç‰©ç†çš„å½¢æ…‹
  'item_1698624006',  // ç‰ˆ
  'item_1698624007',  // éƒ¨ç·¨å
  'item_1698624005',  // å‡ºç‰ˆè€…æƒ…å ±
]);

// ===== è³‡æºã‚¿ã‚¤ãƒ—èªå½™ãƒãƒƒãƒ”ãƒ³ã‚° =====
const RESOURCE_TYPE_MAP = {
  'conference paper':         'http://purl.org/coar/resource_type/c_5794',
  'data paper':               'http://purl.org/coar/resource_type/c_beb9',
  'departmental bulletin paper': 'http://purl.org/coar/resource_type/c_6501',
  'editorial':                'http://purl.org/coar/resource_type/c_b239',
  'journal article':          'http://purl.org/coar/resource_type/c_6501',
  'newspaper':                'http://purl.org/coar/resource_type/c_2fe3',
  'periodical':               'http://purl.org/coar/resource_type/c_2659',
  'review article':           'http://purl.org/coar/resource_type/c_dcae04bc',
  'software paper':           'http://purl.org/coar/resource_type/c_7bab',
  'article':                  'http://purl.org/coar/resource_type/c_6501',
  'book':                     'http://purl.org/coar/resource_type/c_2f33',
  'book part':                'http://purl.org/coar/resource_type/c_3248',
  'cartographic material':    'http://purl.org/coar/resource_type/c_12cc',
  'map':                      'http://purl.org/coar/resource_type/c_12cd',
  'conference object':        'http://purl.org/coar/resource_type/c_c94f',
  'conference proceedings':   'http://purl.org/coar/resource_type/c_f744',
  'conference poster':        'http://purl.org/coar/resource_type/c_6670',
  'dataset':                  'http://purl.org/coar/resource_type/c_ddb1',
  'interview':                'http://purl.org/coar/resource_type/c_26e4',
  'image':                    'http://purl.org/coar/resource_type/c_c513',
  'still image':              'http://purl.org/coar/resource_type/c_ecc8',
  'moving image':             'http://purl.org/coar/resource_type/c_8a7e',
  'video':                    'http://purl.org/coar/resource_type/c_12ce',
  'lecture':                  'http://purl.org/coar/resource_type/c_8544',
  'patent':                   'http://purl.org/coar/resource_type/c_15cd',
  'internal report':          'http://purl.org/coar/resource_type/c_18ww',
  'report':                   'http://purl.org/coar/resource_type/c_93fc',
  'research report':          'http://purl.org/coar/resource_type/c_18ws',
  'technical report':         'http://purl.org/coar/resource_type/c_18gh',
  'policy report':            'http://purl.org/coar/resource_type/c_186u',
  'report part':              'http://purl.org/coar/resource_type/c_ba1f',
  'working paper':            'http://purl.org/coar/resource_type/c_8042',
  'data management plan':     'http://purl.org/coar/resource_type/c_ab20',
  'sound':                    'http://purl.org/coar/resource_type/c_18cc',
  'thesis':                   'http://purl.org/coar/resource_type/c_46ec',
  'bachelor thesis':          'http://purl.org/coar/resource_type/c_7a1f',
  'master thesis':            'http://purl.org/coar/resource_type/c_bdcc',
  'doctoral thesis':          'http://purl.org/coar/resource_type/c_db06',
  'interactive resource':     'http://purl.org/coar/resource_type/c_e9a0',
  'learning object':          'http://purl.org/coar/resource_type/c_e059',
  'manuscript':               'http://purl.org/coar/resource_type/c_0040',
  'musical notation':         'http://purl.org/coar/resource_type/c_18cw',
  'research proposal':        'http://purl.org/coar/resource_type/c_baaf',
  'software':                 'http://purl.org/coar/resource_type/c_5ce6',
  'technical documentation':  'http://purl.org/coar/resource_type/c_71bd',
  'workflow':                 'http://purl.org/coar/resource_type/c_393c',
  'other':                    'http://purl.org/coar/resource_type/c_1843',
};

// ===== ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãƒãƒƒãƒ”ãƒ³ã‚° =====
const ACCESS_RIGHTS_MAP = {
  'embargoed access':       'http://purl.org/coar/access_right/c_f1cf',
  'metadata only access':   'http://purl.org/coar/access_right/c_14cb',
  'open access':            'http://purl.org/coar/access_right/c_abf2',
  'restricted access':      'http://purl.org/coar/access_right/c_16ec',
};

// ===== JPCOAR ãƒªãƒ³ã‚¯ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¼â†’ã‚¹ã‚­ãƒ¼ãƒURLï¼‰=====
const JPCOAR_LINKS = {
  'item_30002_title0':                    'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/1',
  'item_30002_alternative_title1':        'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/2',
  'item_30002_creator2':                  'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/3',
  'item_30002_contributor3':              'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/4',
  'item_30002_access_rights4':            'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/5',
  'item_30002_rights6':                   'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/7',
  'item_30002_rights_holder7':            'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/8',
  'item_30002_subject8':                  'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/9',
  'item_30002_description9':              'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/10',
  'item_30002_publisher10':               'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/11',
  'item_30002_date11':                    'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/12',
  'item_30002_language12':                'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/13',
  'item_30002_resource_type13':           'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/14',
  'item_30002_version14':                 'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/15',
  'item_30002_version_type15':            'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/16',
  'item_30002_identifier16':              'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/17',
  'item_30002_identifier_registration17': 'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/18',
  'item_30002_relation18':                'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/19',
  'item_30002_temporal19':                'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/20',
  'item_30002_geolocation20':             'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/21',
  'item_30002_funding_reference21':       'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/22',
  'item_30002_source_identifier22':       'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/23',
  'item_30002_source_title23':            'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/24',
  'item_30002_volume_number24':           'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/25',
  'item_30002_issue_number25':            'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/26',
  'item_30002_number_of_pages26':         'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/27',
  'item_30002_page_start27':              'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/28',
  'item_30002_page_end28':                'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/29',
  'item_30002_bibliographic_information29': 'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/24',
  'item_30002_conference34':              'https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/34',
};

// ===== titleMap ãƒ‡ãƒ¼ã‚¿ï¼ˆItemType.json ã‹ã‚‰æŠ½å‡ºï¼‰=====
const TITLE_MAPS = {
  // è¨€èªï¼ˆãƒ†ã‚­ã‚¹ãƒˆç³»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨€èªé¸æŠï¼‰
  language: [
    'ja','ja-Kana','en','fr','it','de','es','zh-cn','zh-tw','ru','la','ms','eo','ar','el','ko'
  ],
  // æœ¬æ–‡è¨€èªï¼ˆISO 639-2/T ã‚³ãƒ¼ãƒ‰ï¼‰
  subitem_language: [
    'jpn','eng','aar','abk','afr','aka','amh','ara','arg','arm','asm','ava','ave','aym','aze',
    'bak','bam','bel','ben','bis','bod','bos','bre','bul','cat','ces','cha','che','chu','chv',
    'cor','cos','cre','cym','dan','deu','div','dzo','ell','epo','est','eus','ewe','fao','fas',
    'fij','fin','fra','fry','ful','gla','gle','glg','glv','grn','guj','hat','hau','heb','her',
    'hin','hmo','hrv','hun','hye','ibo','ido','iii','iku','ile','ina','ind','ipk','isl','ita',
    'jav','kal','kan','kas','kat','kau','kaz','khm','kik','kin','kir','kom','kon','kor','kua',
    'kur','lao','lat','lav','lim','lin','lit','ltz','lub','lug','mkd','mlg','mlt','mon','mri',
    'msa','mya','nau','nav','nbl','nde','ndo','nep','nno','nob','nor','nya','oci','oji','ori',
    'orm','oss','pan','pli','pol','por','pus','que','roh','ron','run','rus','sag','san','sin',
    'slk','slv','sme','smo','sna','snd','som','sot','spa','sqi','srd','srp','ssw','sun','swa',
    'swe','tah','tam','tat','tel','tgk','tgl','tha','tir','ton','tsn','tso','tuk','tur','twi',
    'uig','ukr','urd','uzb','ven','vie','vol','wln','wol','xho','yid','yor','zha','zho','zul'
  ],
  // è³‡æºã‚¿ã‚¤ãƒ—ï¼ˆItemType.json ã® resourcetype titleMapï¼‰
  resourcetype: [
    'conference paper','data paper','departmental bulletin paper','editorial',
    'journal','journal article','newspaper','review article','other periodical',
    'software paper','article','book','book part','cartographic material','map',
    'conference output','conference presentation','conference proceedings','conference poster',
    'aggregated data','clinical trial data','compiled data','encoded data','experimental data',
    'genomic data','geospatial data','laboratory notebook','measurement and test data',
    'observational data','recorded data','simulation data','survey data',
    'dataset','image','still image','moving image','video',
    'lecture','patent','internal report','report','research report','technical report',
    'policy report','report part','working paper','data management plan',
    'sound','thesis','bachelor thesis','master thesis','doctoral thesis',
    'interactive resource','learning object','manuscript','musical notation',
    'research proposal','software','technical documentation','workflow','other'
  ],
  // ã‚¢ã‚¯ã‚»ã‚¹æ¨©
  subitem_access_right: ['embargoed access','metadata only access','open access','restricted access'],
  // å‡ºç‰ˆã‚¿ã‚¤ãƒ—
  subitem_version_type: ['AO','SMUR','AM','P','VoR','CVoR','EVoR','NA'],
  // å†…å®¹è¨˜è¿°ã‚¿ã‚¤ãƒ—
  subitem_description_type: ['Abstract','Methods','TableOfContents','TechnicalInfo','Other'],
  // æ—¥ä»˜ã‚¿ã‚¤ãƒ—
  subitem_date_issued_type: ['Accepted','Available','Collected','Copyrighted','Created','Issued','Submitted','Updated','Valid'],
  // æ›¸èªŒç™ºè¡Œæ—¥ã‚¿ã‚¤ãƒ—
  bibliographicIssueDateType: ['Issued'],
  // é–¢é€£ã‚¿ã‚¤ãƒ—
  subitem_relation_type: [
    'isVersionOf','hasVersion','isPartOf','hasPart','isReferencedBy','references',
    'isFormatOf','hasFormat','isReplacedBy','replaces','isRequiredBy','requires',
    'isSupplementedBy','isSupplementTo','isIdenticalTo','isDerivedFrom','isSourceOf',
    'isCitedBy','Cites','inSeries'
  ],
  // é–¢é€£è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—
  subitem_relation_type_select: [
    'ARK','arXiv','DOI','HDL','ICHUSHI','ISBN','J-GLOBAL','Local',
    'PISSN','EISSN','ISSN','NAID','NCID','PMID','PURL','SCOPUS','URI','WOS','CRID'
  ],
  // åéŒ²ç‰©è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—
  subitem_source_identifier_type: ['PISSN','EISSN','ISSN','NCID'],
  // å¯„ä¸è€…ã‚¿ã‚¤ãƒ—
  contributorType: [
    'ContactPerson','DataCollector','DataCurator','DataManager','Distributor','Editor',
    'HostingInstitution','Producer','ProjectLeader','ProjectManager','ProjectMember',
    'RelatedPerson','Researcher','ResearchGroup','Sponsor','Supervisor','WorkPackageLeader','Other'
  ],
  // æ‰€å±æ©Ÿé–¢è­˜åˆ¥å­ã‚¹ã‚­ãƒ¼ãƒ 
  affiliationNameIdentifierScheme: ['ISNI','ROR','GRID','kakenhi','Ringgold'],
  // è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—ï¼ˆä½œæˆè€…/å¯„ä¸è€…ï¼‰
  nameIdentifierScheme: ['ORCID','CiNii','ISNI','J-GLOBAL'],
  // è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—ï¼ˆä½œæˆè€…å§“åã‚¿ã‚¤ãƒ—ï¼‰
  creatorNameType: ['Personal','Organizational'],
  // è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—ï¼ˆè­˜åˆ¥å­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
  subitem_identifier_type: ['DOI','HDL','URI','CRID'],
  // åŠ©æˆæ©Ÿé–¢è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—
  subitem_funder_identifier_type: ['Crossref Funder','ISNI','ROR','Other'],
  // é–‹å‚¬å›½ï¼ˆISO 3166-1 alpha-3ï¼‰
  subitem_conference_country: [
    'JPN','ABW','AFG','AGO','AIA','ALA','ALB','AND','ARE','ARG','ARM','ASM','ATA','ATF','ATG',
    'AUS','AUT','AZE','BDI','BEL','BEN','BES','BFA','BGD','BGR','BHR','BHS','BIH','BLM','BLR',
    'BLZ','BMU','BOL','BRA','BRB','BRN','BTN','BVT','BWA','CAF','CAN','CCK','CHE','CHL','CHN',
    'CIV','CMR','COD','COG','COK','COL','COM','CPV','CRI','CUB','CUW','CXR','CYM','CYP','CZE',
    'DEU','DJI','DMA','DNK','DOM','DZA','ECU','EGY','ERI','ESH','ESP','EST','ETH','FIN','FJI',
    'FLK','FRA','FRO','FSM','GAB','GBR','GEO','GGY','GHA','GIB','GIN','GLP','GMB','GNB','GNQ',
    'GRC','GRD','GRL','GTM','GUF','GUM','GUY','HKG','HMD','HND','HRV','HTI','HUN','IDN','IMN',
    'IND','IOT','IRL','IRN','IRQ','ISL','ISR','ITA','JAM','JEY','JOR','KAZ','KEN','KGZ','KHM',
    'KIR','KNA','KOR','KWT','LAO','LBN','LBR','LBY','LCA','LIE','LKA','LSO','LTU','LUX','LVA',
    'MAC','MAF','MAR','MCO','MDA','MDG','MDV','MEX','MHL','MKD','MLI','MLT','MMR','MNE','MNG',
    'MNP','MOZ','MRT','MSR','MTQ','MUS','MWI','MYS','MYT','NAM','NCL','NER','NFK','NGA','NIC',
    'NIU','NLD','NOR','NPL','NRU','NZL','OMN','PAK','PAN','PCN','PER','PHL','PLW','PNG','POL',
    'PRI','PRK','PRT','PRY','PSE','PYF','QAT','REU','ROU','RUS','RWA','SAU','SDN','SEN','SGP',
    'SGS','SHN','SJM','SLB','SLE','SLV','SMR','SOM','SPM','SRB','SSD','STP','SUR','SVK','SVN',
    'SWE','SWZ','SXM','SYC','SYR','TCA','TCD','TGO','THA','TJK','TKL','TKM','TLS','TON','TTO',
    'TUN','TUR','TUV','TWN','TZA','UGA','UKR','UMI','URY','USA','UZB','VAT','VCT','VEN','VGB',
    'VIR','VNM','VUT','WLF','WSM','YEM','ZAF','ZMB','ZWE',
  ],
};

// ===== æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ===== select ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
// values: æ–‡å­—åˆ—é…åˆ— ã¾ãŸã¯ {name, value}é…åˆ—
// selected: åˆæœŸé¸æŠå€¤
// onChange: å€¤å¤‰åŒ–æ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯(value)
function buildSelect(values, selected, onChange) {
  const sel = document.createElement('select');
  for (const v of values) {
    const name  = (typeof v === 'object') ? v.name  : v;
    const value = (typeof v === 'object') ? v.value : v;
    const o = document.createElement('option');
    o.value = value;
    o.textContent = name;
    if (value === selected) o.selected = true;
    sel.appendChild(o);
  }
  if (onChange) sel.addEventListener('change', () => onChange(sel.value));
  return sel;
}

// ===== HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— =====
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== å‚ç…§å€¤ï¼ˆãƒ’ãƒ³ãƒˆï¼‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
// URL ã‚’è‡ªå‹•ãƒªãƒ³ã‚¯åŒ–ã—ã¦è¿”ã™
function renderHint(val) {
  if (!val) return '';
  return String(val).split(/(\s+)/).map(part => {
    if (/^https?:\/\//.test(part))
      return `<a href="${escHtml(part)}" target="_blank">${escHtml(part)}</a>`;
    return escHtml(part);
  }).join('');
}

// å‚ç…§å€¤è¡¨ç¤ºãƒ•ãƒ©ã‚°ï¼ˆAPIå–å¾—æ™‚ trueã€ç©ºå€¤è¡¨ç¤ºæ™‚ falseï¼‰
let showHints = false;

// ===== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º =====
function showError(msg) {
  const el = document.getElementById('error-msg');
  if (msg) { el.textContent = msg; el.style.display = 'block'; }
  else { el.style.display = 'none'; }
}

// ===== ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ =====
function toggleAccordion(headerEl) {
  const content = headerEl.nextElementSibling;
  const icon = headerEl.querySelector('.toggle-icon');
  const summary = headerEl.querySelector('.summary') || headerEl.querySelector('.item-summary');

  if (!content) return;
  if (content.style.display === 'none') {
    content.style.display = '';
    if (icon) icon.textContent = 'â–¼';
    if (summary) summary.style.display = 'none';
  } else {
    content.style.display = 'none';
    if (icon) icon.textContent = 'â–¶';
    if (summary) {
      summary.style.display = 'inline';
    }
  }
}

// ===== ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æç”» =====
function renderSystemFields(systemData) {
  const tbody = document.getElementById('system-fields-body');
  tbody.innerHTML = '';

  const sysRows = [
    { label: '.id',                  hint: 'æ–°è¦ç™»éŒ²æ™‚ã¯ç©ºæ¬„', key: 'sys_id',      type: 'text',   default: '' },
    { label: '.uri',                 hint: 'æ–°è¦ç™»éŒ²æ™‚ã¯ç©ºæ¬„', key: 'sys_uri',     type: 'text',   default: '' },
    { label: '.IndexID[0]',          hint: '.metadata.path[0]', key: 'sys_path',  type: 'text',   default: '' },
    { label: '.POS_INDEX[0]',        hint: '1718256617194',    key: 'sys_pos',     type: 'text',   default: document.getElementById('pos-index-input').value },
    { label: '.PUBLISH_STATUS',      hint: 'private / public', key: 'sys_status',  type: 'select', options: ['private','public'], default: 'private' },
    { label: '.FEEDBACK_MAIL[0]',    hint: '',                  key: 'sys_mail',   type: 'text',   default: '' },
    { label: '.CNRI',                hint: '',                  key: 'sys_cnri',   type: 'text',   default: '' },
    { label: '.DOI_RA',              hint: 'JaLC / Crossref',  key: 'sys_doi_ra',  type: 'select', options: ['','JaLC','Crossref'], default: '' },
    { label: '.DOI',                 hint: '',                  key: 'sys_doi',    type: 'text',   default: '' },
    { label: 'Keep/Upgrade Version', hint: 'Keep / Upgrade',   key: 'sys_edit',    type: 'select', options: ['Keep','Upgrade'], default: 'Keep' },
    { label: 'å…¬é–‹æ—¥',               hint: 'YYYY-MM-DD',        key: 'sys_pubdate', type: 'text',   default: todayStr() },
  ];

  for (const row of sysRows) {
    const tr = document.createElement('tr');
    const tdLabel = document.createElement('td');
    tdLabel.textContent = row.label;
    const tdHint = document.createElement('td');
    tdHint.textContent = row.hint;
    const tdVal = document.createElement('td');

    const val = (systemData && systemData[row.key] !== undefined) ? systemData[row.key] : row.default;

    if (row.type === 'select') {
      const sel = document.createElement('select');
      sel.dataset.key = row.key;
      for (const opt of row.options) {
        const o = document.createElement('option');
        o.value = opt; o.textContent = opt || 'ï¼ˆæœªè¨­å®šï¼‰';
        if (opt === val) o.selected = true;
        sel.appendChild(o);
      }
      tdVal.appendChild(sel);
    } else {
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.value = val;
      inp.dataset.key = row.key;
      tdVal.appendChild(inp);
    }

    tr.appendChild(tdLabel);
    tr.appendChild(tdHint);
    tr.appendChild(tdVal);
    tbody.appendChild(tr);
  }
}

// ================================================================
// STEP 3: API å–å¾—å±¤
// ================================================================

// ===== DOI æ­£è¦åŒ– =====
function normalizeDoi(raw) {
  return raw.trim()
    .replace(/^https?:\/\/doi\.org\//i, '')
    .replace(/^doi:/i, '')
    .trim();
}

// ===== 3.0 DOI RAåˆ¤å®š =====
async function fetchDoiRA(doi) {
  const resp = await fetch(`https://doi.org/doiRA/${encodeURIComponent(doi)}`);
  if (!resp.ok) throw new Error(`DOI RAåˆ¤å®šAPIã‚¨ãƒ©ãƒ¼: ${resp.status}`);
  const data = await resp.json();
  const entry = data[0];
  if (!entry || entry.status) {
    throw new Error('å…¥åŠ›ã•ã‚ŒãŸDOIã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚');
  }
  return entry.RA;
}

// ===== 3.1 Crossref API =====
async function fetchCrossref(doi) {
  const resp = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);
  if (!resp.ok) {
    if (resp.status === 404) throw new Error('DOIãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆCrossref 404ï¼‰');
    throw new Error(`Crossref APIã‚¨ãƒ©ãƒ¼: ${resp.status}`);
  }
  const data = await resp.json();
  return data.message;
}

// ===== 3.2 OpenAlex API =====
async function fetchOpenAlex(doi) {
  let url = `https://api.openalex.org/works/doi:${encodeURIComponent(doi)}`;
  if (CONFIG.OpenAlex_API_KEY && CONFIG.OpenAlex_API_KEY !== 'YOUR_OpenAlex_API_KEY') {
    url += `?api_key=${encodeURIComponent(CONFIG.OpenAlex_API_KEY)}`;
  }
  const resp = await fetch(url);
  if (!resp.ok) {
    if (resp.status === 404) throw new Error('DOIãŒOpenAlexã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    if (resp.status === 409) throw new Error('OpenAlex API Keyãªã—ã§ã®åˆ©ç”¨å›æ•°ã®åˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€‚https://openalex.org/pricing ã§API Keyã‚’å–å¾—ã—ã€è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    throw new Error(`OpenAlex APIã‚¨ãƒ©ãƒ¼: ${resp.status}`);
  }
  return await resp.json();
}

// ===== 3.3 ROR v2 APIï¼ˆå˜ä½“ï¼‰ =====
// rorUri: "https://ror.org/005pdtr14" å½¢å¼
async function fetchRorDetails(rorUri) {
  // ROR ID éƒ¨åˆ†ã ã‘ã‚’æŠ½å‡º
  const rorId = rorUri.replace(/^https?:\/\/ror\.org\//i, '').replace(/\/$/, '');
  const resp = await fetch(`https://api.ror.org/v2/organizations/${encodeURIComponent(rorId)}`);
  if (!resp.ok) return { isni: '', rorDisplayName: '', rorId };

  const data = await resp.json();

  // ror_display ã‚¿ã‚¤ãƒ—ã®åç§°ã‚’å–å¾—
  const rorDisplayEntry = (data.names || []).find(n =>
    Array.isArray(n.types) && n.types.includes('ror_display')
  );
  const rorDisplayName = rorDisplayEntry ? rorDisplayEntry.value : '';

  // ISNI å–å¾—ï¼ˆã‚¹ãƒšãƒ¼ã‚¹é™¤å»ï¼‰
  const isniEntry = (data.external_ids || []).find(e => e.type === 'isni');
  const isni = isniEntry && isniEntry.all && isniEntry.all[0]
    ? isniEntry.all[0].replace(/\s+/g, '')
    : '';

  return { isni, rorDisplayName, rorId };
}

// ===== 3.4 å…¨è‘—è€…ã® ROR ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾— =====
async function fetchAllRorData(oaJson) {
  const rorMap = new Map(); // rorUri â†’ { isni, rorDisplayName, rorId }

  const rorUris = new Set();
  for (const authorship of (oaJson.authorships || [])) {
    for (const inst of (authorship.institutions || [])) {
      if (inst.ror) rorUris.add(inst.ror);
    }
  }

  await Promise.all([...rorUris].map(async (rorUri) => {
    try {
      const info = await fetchRorDetails(rorUri);
      rorMap.set(rorUri, info);
    } catch {
      rorMap.set(rorUri, { isni: '', rorDisplayName: '', rorId: rorUri });
    }
  }));

  return rorMap;
}

// ===== 3.5 CiNii Research KAKEN API =====
async function fetchKaken(awardNumber) {
  // JP ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹é™¤å»
  const projectId = awardNumber.replace(/^JP/i, '');
  const appid = encodeURIComponent(CONFIG.CiNii_API_KEY);

  // æ—¥æœ¬èªãƒ»è‹±èªã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¸¦åˆ—å–å¾—
  const [jaResp, enResp] = await Promise.all([
    fetch(`https://cir.nii.ac.jp/opensearch/v2/projects?appid=${appid}&format=json&projectId=${encodeURIComponent(projectId)}`),
    fetch(`https://cir.nii.ac.jp/opensearch/v2/projects?appid=${appid}&format=json&projectId=${encodeURIComponent(projectId)}&lang=en`),
  ]);

  if (!jaResp.ok || !enResp.ok) return null;

  const jaData = await jaResp.json();
  const enData = await enResp.json();

  if (!jaData.items?.length) return null;

  const jaTitle = jaData.items[0].title || '';
  const enTitle = enData.items?.[0]?.title || '';
  const kakenUrl = jaData.items[0]['dc:source']?.[0]?.['@id'] || '';

  // æ—¥è‹±ã‚¿ã‚¤ãƒˆãƒ«ãŒåŒä¸€ã®å ´åˆã¯è‹±èªã‚¿ã‚¤ãƒˆãƒ«ãªã—
  const titles = [];
  if (jaTitle) {
    titles.push({ subitem_award_title: jaTitle, subitem_award_title_language: 'ja' });
  }
  if (enTitle && enTitle !== jaTitle) {
    titles.push({ subitem_award_title: enTitle, subitem_award_title_language: 'en' });
  }

  return { titles, kakenUrl };
}

// ===== 3.5.1 CiNii Research NCIDå–å¾— =====
async function fetchNcid(issns) {
  const appidParam = CONFIG.CiNii_API_KEY && CONFIG.CiNii_API_KEY !== 'YOUR_CiNii_API_KEY'
    ? `&appid=${encodeURIComponent(CONFIG.CiNii_API_KEY)}` : '';
  for (const issn of issns) {
    const url = `https://cir.nii.ac.jp/opensearch/v2/books?issn=${encodeURIComponent(issn)}&format=json${appidParam}`;
    try {
      const resp = await fetch(url);
      if (!resp.ok) continue;
      const data = await resp.json();
      if (!data.items?.length) continue;
      const ids = data.items[0]['dc:identifier'] || [];
      const ncidObj = ids.find(id => id['@type'] === 'cir:NCID');
      if (ncidObj?.['@value']) return ncidObj['@value'];
    } catch { continue; }
  }
  return null;
}

// ===== 3.6 Crossref DOI ãƒ‡ãƒ¼ã‚¿å–å¾— =====
async function fetchCrossrefData(doi) {
  // Crossref + OpenAlex ã‚’ä¸¦åˆ—å–å¾—
  const [crJson, oaJson] = await Promise.all([
    fetchCrossref(doi),
    fetchOpenAlex(doi),
  ]);

  // ROR ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾—
  const rorMap = await fetchAllRorData(oaJson);

  // æƒ…å ±ãƒãƒ¼è¡¨ç¤º
  const doiUrl = `https://doi.org/${doi}`;
  const doiLink = document.getElementById('doi-link');
  doiLink.href = doiUrl;
  doiLink.textContent = doiUrl;

  const oaStatus = oaJson.open_access?.oa_status || '';
  const isOa = oaJson.open_access?.is_oa || false;
  const badge = document.getElementById('oa-badge');
  badge.textContent = isOa
    ? (oaStatus === 'gold'   ? 'ğŸŸ¡ Gold OA'
     : oaStatus === 'green'  ? 'ğŸŸ¢ Green OA'
     : oaStatus === 'hybrid' ? 'ğŸ”µ Hybrid OA'
     : 'âšª Other OA')
    : 'ğŸ”´ Closed';
  badge.style.background = isOa ? '#4caf50' : '#999';
  document.getElementById('info-bar').style.display = 'flex';

  // ãƒãƒƒãƒ”ãƒ³ã‚° â†’ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  const metadata = await mapToItemType(crJson, oaJson, rorMap);
  showHints = true;
  renderAll(metadata);
}

// ===== 3.7 ãƒ¡ã‚¤ãƒ³å–å¾—ãƒ•ãƒ­ãƒ¼ =====
async function fetchData() {
  showError('');
  const rawDoi = document.getElementById('doi-input').value.trim();
  if (!rawDoi) { showError('DOIã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  const doi = normalizeDoi(rawDoi);

  document.getElementById('info-bar').style.display = 'none';
  document.getElementById('preview-area').style.display = 'none';
  const loading = document.getElementById('loading');
  loading.style.display = 'block';

  try {
    // RAåˆ¤å®š
    const ra = await fetchDoiRA(doi);

    if (ra === 'Crossref') {
      await fetchCrossrefData(doi);
    } else if (ra === 'JaLC') {
      showError('JaLC DOI ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ç¾åœ¨æœªå¯¾å¿œã§ã™ã€‚ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å¯¾å¿œäºˆå®šã§ã™ã€‚');
    } else {
      showError(`ã“ã® DOI ã®ç™»éŒ²æ©Ÿé–¢ (${ra}) ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
    }
  } catch (e) {
    showError(`ã‚¨ãƒ©ãƒ¼: ${e.message}`);
  } finally {
    loading.style.display = 'none';
  }
}

// ===== 3.8 ç©ºå€¤ãƒ†ã‚¹ãƒˆè¡¨ç¤º =====
function showEmptyFields() {
  showError('');
  showHints = false;
  renderAll(buildEmptyMetadata());
}

// ================================================================
// STEP 4: ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°å±¤
// ================================================================

// ===== 4.6 ã‚¢ãƒ–ã‚¹ãƒˆãƒ©ã‚¯ãƒˆ JATS å‡¦ç† =====
function processAbstract(raw) {
  if (!raw) return '';
  // 1. æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
  let text = raw.replace(/\r?\n/g, '');
  // 2. ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸå®Ÿä½“å‚ç…§ã‚’è§£é™¤
  text = text.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&')
              .replace(/&apos;/g, "'").replace(/&quot;/g, '"');
  // 3. å…ˆé ­ã® <jats:title>...</jats:title> ã‚’å‰Šé™¤
  text = text.replace(/^<jats:title>[^<]*<\/jats:title>/, '');
  // 4. <jats:sec> å†…ã® <jats:title>...</jats:title> ã‚’ "TITLE: " å½¢å¼ã«å¤‰æ›
  text = text.replace(/<jats:title>([^<]*)<\/jats:title>/g, '$1: ');
  // 5 & 6. æ®‹å­˜ã™ã‚‹å…¨ã‚¿ã‚°ã‚’é™¤å»ï¼ˆ<jats:p> ç­‰ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ãã®ã¾ã¾å–ã‚Šè¾¼ã¿ï¼‰
  text = text.replace(/<[^>]+>/g, '');
  // 7. é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«çµ±ä¸€ãƒ»trim
  text = text.replace(/ {2,}/g, ' ').trim();
  return text;
}

// ===== ç™ºè¡Œæ—¥å–å¾— =====
function getPubDate(cr) {
  const parts = cr['published-online']?.['date-parts']?.[0]
    || cr['published-print']?.['date-parts']?.[0]
    || cr.published?.['date-parts']?.[0] || [];
  if (!parts.length) return '';
  if (parts.length >= 3) return `${parts[0]}-${String(parts[1]).padStart(2,'0')}-${String(parts[2]).padStart(2,'0')}`;
  if (parts.length === 2) return `${parts[0]}-${String(parts[1]).padStart(2,'0')}`;
  return String(parts[0]);
}

// ===== 4.3 è‘—è€…ãƒãƒƒãƒ”ãƒ³ã‚° =====
function buildAuthors(crAuthors, oaAuthorships, rorMap) {
  // OpenAlex è‘—è€…ã‚’å§“ã§ç´¢å¼•åŒ–
  const oaByFamily = {};
  const oaByIndex = [];
  (oaAuthorships || []).forEach((a, i) => {
    oaByIndex[i] = a;
    const dn = (a.author?.display_name || '').toLowerCase();
    // "Sakiko Shiratori" â†’ last word as family
    const parts = dn.split(/\s+/);
    const familyKey = parts[parts.length - 1] || '';
    if (familyKey) oaByFamily[familyKey] = a;
  });

  return (crAuthors || []).map((crA, idx) => {
    const family = crA.family || '';
    const given  = crA.given  || '';
    const fullName = family && given ? `${family}, ${given}` : family || given;

    // OpenAlex ã‚¨ãƒ³ãƒˆãƒªã¨ç…§åˆï¼ˆå§“â†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é †ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    const familyLower = family.toLowerCase();
    const oaEntry = oaByFamily[familyLower] || oaByIndex[idx] || null;

    // ORCID: Crossref å„ªå…ˆ â†’ OpenAlex fallbackï¼ˆwarn ãƒ•ãƒ©ã‚°ä»˜ãï¼‰
    const crOrcid = crA.ORCID || '';
    const oaOrcid = oaEntry?.author?.orcid || '';
    const orcidUri = crOrcid || oaOrcid || '';
    const orcidFromOA = !crOrcid && !!oaOrcid;
    const orcidId = orcidUri.replace(/^https?:\/\/orcid\.org\//i, '');

    // æ‰€å±: OpenAlex authorships[].institutions ã‚’ä½¿ç”¨
    const oaInsts = oaEntry?.institutions || [];
    const affiliations = oaInsts.map(inst => {
      const rorUri = inst.ror || '';
      const rorInfo = rorUri ? (rorMap.get(rorUri) || {}) : {};
      const dispName = rorInfo.rorDisplayName || inst.display_name || '';
      const isni     = rorInfo.isni || '';
      const rorId    = rorInfo.rorId || '';

      const affiliationNameIdentifiers = [];
      if (isni) affiliationNameIdentifiers.push({
        affiliationNameIdentifier:       isni,
        affiliationNameIdentifierScheme: 'ISNI',
        affiliationNameIdentifierURI:    `https://isni.org/isni/${isni}`,
      });
      if (rorId) affiliationNameIdentifiers.push({
        affiliationNameIdentifier:       rorId,
        affiliationNameIdentifierScheme: 'ROR',
        affiliationNameIdentifierURI:    `https://ror.org/${rorId}`,
      });

      return {
        affiliationNames: dispName
          ? [{ affiliationName: dispName, affiliationNameLang: 'en', _warnLang: true }]
          : [],
        affiliationNameIdentifiers,
      };
    });

    const nameIdentifiers = orcidId
      ? [{ nameIdentifier: orcidId, nameIdentifierScheme: 'ORCID', nameIdentifierURI: `https://orcid.org/${orcidId}`, _warnOrcid: orcidFromOA }]
      : [];

    return {
      creatorType: 'Author',
      creatorNames: [{ creatorName: fullName, creatorNameLang: 'en', creatorNameType: 'Personal', _warnLang: true }],
      familyNames:  family ? [{ familyName: family, familyNameLang: 'en', _warnLang: true }] : [],
      givenNames:   given  ? [{ givenName:  given,  givenNameLang:  'en', _warnLang: true }] : [],
      nameIdentifiers,
      creatorAffiliations: affiliations,
    };
  });
}

// ===== 4.4 åŠ©æˆæƒ…å ±ãƒãƒƒãƒ”ãƒ³ã‚° =====
async function buildFunders(crFunders) {
  const JSPS_DOI = '10.13039/501100001691';
  const isKakenEnabled = CONFIG.CiNii_API_KEY
                      && CONFIG.CiNii_API_KEY !== 'YOUR_CiNii_API_KEY';

  const entries = await Promise.all((crFunders || []).map(async (f) => {
    const name      = f.name  || '';
    const funderDoi = f.DOI   || '';
    const awards    = f.award || [];

    // JSPSåˆ¤å®š: DOIä¸€è‡´ ã‹ã¤ CiNii_API_KEYè¨­å®šæ¸ˆã¿
    const isJsps = isKakenEnabled && funderDoi === JSPS_DOI;

    const buildEntry = async (awardNum) => {
      const obj = {};
      obj.subitem_funder_names = name
        ? [{ subitem_funder_name: name, subitem_funder_name_language: 'en' }]
        : [];

      if (funderDoi) {
        obj.subitem_funder_identifiers = {
          subitem_funder_identifier:      `https://doi.org/${funderDoi}`,
          subitem_funder_identifier_type: 'Crossref Funder',
        };
      } else {
        obj.subitem_funder_identifiers = { subitem_funder_identifier: '', subitem_funder_identifier_type: '' };
      }

      // KAKENé€£æº: JSPS ã‹ã¤ awardç•ªå·ã‚ã‚Šã®å ´åˆ
      let kakenResult = null;
      if (isJsps && awardNum) {
        try {
          kakenResult = await fetchKaken(awardNum);
        } catch (e) {
          console.warn(`KAKENå–å¾—å¤±æ•— (${awardNum}):`, e.message);
        }
      }

      obj.subitem_award_numbers = {
        subitem_award_number:      awardNum,
        subitem_award_number_type: '',
        subitem_award_uri:         kakenResult?.kakenUrl || '',
      };

      obj.subitem_award_titles = kakenResult?.titles || [];
      return obj;
    };

    if (awards.length === 0) return [await buildEntry('')];
    return Promise.all(awards.map(aw => buildEntry(aw)));
  }));

  return entries.flat();
}

// ===== 4.1 ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°é–¢æ•° =====
async function mapToItemType(crJson, oaJson, rorMap) {
  const doi        = crJson.DOI || '';
  const pubDate    = getPubDate(crJson);
  const isOa       = oaJson.open_access?.is_oa   || false;
  const oaStatus   = oaJson.open_access?.oa_status || '';
  const isGoldOa   = isOa && (oaStatus === 'gold' || oaStatus === 'hybrid');

  // ===== ã‚¿ã‚¤ãƒˆãƒ« =====
  const title = (crJson.title || [])[0] || '';

  // ===== ä½œæˆè€… =====
  const creators = buildAuthors(crJson.author || [], oaJson.authorships || [], rorMap);

  // ===== æ¨©åˆ©æƒ…å ± =====
  const rights = [];
  // 1) vor ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ URL
  const vorLicense = (crJson.license || []).find(l => l['content-version'] === 'vor');
  if (vorLicense) {
    rights.push({
      subitem_rights:          '',
      subitem_rights_language: 'en',
      subitem_rights_resource: vorLicense.URL,
    });
  }
  // 2) Copyright assertion
  (crJson.assertion || []).filter(a => a.label === 'Copyright').forEach(a => {
    rights.push({
      subitem_rights:          a.value,
      subitem_rights_language: 'en',
      subitem_rights_resource: '',
    });
  });

  // ===== ä¸»é¡Œï¼ˆAPIå–ã‚Šè¾¼ã¿å¯¾è±¡å¤–: ç©ºã®ç·¨é›†å¯èƒ½ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æº–å‚™ã™ã‚‹ã®ã¿ï¼‰=====
  const subjects = [{
    subitem_subject:          '',
    subitem_subject_language: '',
    subitem_subject_scheme:   '',
    subitem_subject_uri:      '',
  }];

  // ===== è³‡æºã‚¿ã‚¤ãƒ— =====
  const crType        = (crJson.type || '').replace(/-/g, ' ');
  const resourcetype  = TITLE_MAPS.resourcetype.includes(crType) ? crType : '';
  const resourceuri   = resourcetype ? (RESOURCE_TYPE_MAP[resourcetype] || '') : '';

  // ===== å‡ºç‰ˆã‚¿ã‚¤ãƒ— =====
  const versionType     = isGoldOa ? 'VoR' : 'AM';
  const versionResource = isGoldOa
    ? 'http://purl.org/coar/version/c_970fb48d4fbd8a85'
    : 'http://purl.org/coar/version/c_ab4af688f83e57aa';

  // ===== ISSN =====
  const sourceIdentifiers = [];
  (crJson['issn-type'] || []).forEach(i => {
    const itype = i.type === 'electronic' ? 'EISSN' : i.type === 'print' ? 'PISSN' : 'ISSN';
    sourceIdentifiers.push({ subitem_source_identifier: i.value, subitem_source_identifier_type: itype });
  });
  if (!sourceIdentifiers.length) {
    (crJson.ISSN || []).forEach(i => sourceIdentifiers.push({ subitem_source_identifier: i, subitem_source_identifier_type: 'ISSN' }));
  }

  // ===== NCID (CiNii Research) =====
  const allIssns = sourceIdentifiers.map(si => si.subitem_source_identifier);
  if (allIssns.length) {
    const ncid = await fetchNcid(allIssns);
    if (ncid) {
      sourceIdentifiers.push({ subitem_source_identifier: ncid, subitem_source_identifier_type: 'NCID', _ncidUrl: `https://ci.nii.ac.jp/ncid/${ncid}` });
    }
  }

  // ===== åéŒ²ç‰©å =====
  const containerTitle = (crJson['container-title'] || [])[0] || '';

  // ===== æ›¸èªŒæƒ…å ± =====
  const pageStr = crJson.page || '';
  const pageParts = pageStr.split('-');
  const pageStart = pageParts[0] || '';
  const pageEnd   = pageParts[1] || '';

  // ===== ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ =====
  const metadata = {
    // ----- ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -----
    system: {
      id:             '',
      uri:            '',
      path:           '',
      pos_index:      document.getElementById('pos-index-input').value,
      publish_status: 'private',
      feedback_mail:  '',
      cnri:           '',
      doi_ra:         '',
      doi:            '',
      edit_mode:      'Keep',
      pubdate:        todayStr(),
    },

    // ----- ã‚¿ã‚¤ãƒˆãƒ« -----
    item_30002_title0: title
      ? [{ subitem_title: title, subitem_title_language: 'en', _warnLang: true }]
      : [],

    // ----- ãã®ä»–ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºï¼‰-----
    item_30002_alternative_title1: [],

    // ----- ä½œæˆè€… -----
    item_30002_creator2: creators,

    // ----- å¯„ä¸è€…ï¼ˆç©ºï¼‰-----
    item_30002_contributor3: [],

    // ----- ã‚¢ã‚¯ã‚»ã‚¹æ¨© -----
    item_30002_access_rights4: {
      subitem_access_right:     'open access',
      subitem_access_right_uri: 'http://purl.org/coar/access_right/c_abf2',
    },

    // ----- æ¨©åˆ©æƒ…å ± -----
    item_30002_rights6: rights,

    // ----- æ¨©åˆ©è€…æƒ…å ±ï¼ˆç©ºï¼‰-----
    item_30002_rights_holder7: [],

    // ----- ä¸»é¡Œ -----
    item_30002_subject8: subjects,

    // ----- å†…å®¹è¨˜è¿° -----
    item_30002_description9: crJson.abstract
      ? [{ subitem_description: processAbstract(crJson.abstract), subitem_description_language: 'en', subitem_description_type: 'Abstract' }]
      : [],

    // ----- å‡ºç‰ˆè€… -----
    item_30002_publisher10: crJson.publisher
      ? [{ subitem_publisher: crJson.publisher, subitem_publisher_language: 'en' }]
      : [],

    // ----- æ—¥ä»˜ -----
    item_30002_date11: pubDate
      ? [{ subitem_date_issued_datetime: pubDate, subitem_date_issued_type: 'Issued' }]
      : [],

    // ----- è¨€èª -----
    item_30002_language12: [{ subitem_language: 'eng' }],

    // ----- è³‡æºã‚¿ã‚¤ãƒ— -----
    item_30002_resource_type13: { resourcetype, resourceuri },

    // ----- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ï¼ˆç©ºï¼‰-----
    item_30002_version14: { subitem_version: '' },

    // ----- å‡ºç‰ˆã‚¿ã‚¤ãƒ— -----
    item_30002_version_type15: {
      subitem_version_resource: versionResource,
      subitem_version_type:     versionType,
    },

    // ----- è­˜åˆ¥å­ï¼ˆç©ºï¼‰-----
    item_30002_identifier16: [],

    // ----- IDç™»éŒ²ï¼ˆç©ºï¼‰-----
    item_30002_identifier_registration17: { subitem_identifier_reg_text: '', subitem_identifier_reg_type: '' },

    // ----- é–¢é€£æƒ…å ± -----
    item_30002_relation18: (() => {
      // relatedIdentifier.md ã«å®šç¾©ã•ã‚ŒãŸè­˜åˆ¥å­ã‚¿ã‚¤ãƒ—
      const VALID_RELATION_ID_TYPES = new Set([
        'ARK','ARXIV','DOI','HDL','ICHUSHI','ISBN','J-GLOBAL','LOCAL',
        'PISSN','EISSN','ISSN','NAID','NCID','PMID','PURL','SCOPUS','URI','WOS',
      ]);
      const relations = [];
      // 1) Crossref DOI ã‚¨ãƒ³ãƒˆãƒªï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒãªã„ã®ã§ subitem_relation_name: []ï¼‰
      if (doi) {
        relations.push({
          subitem_relation_type: 'isIdenticalTo',
          subitem_relation_type_id: {
            subitem_relation_type_id_text: `https://doi.org/${doi}`,
            subitem_relation_type_select: 'DOI',
          },
          subitem_relation_name: [],
        });
      }
      // 2) OpenAlex ids ã‹ã‚‰è¿½åŠ ã‚¨ãƒ³ãƒˆãƒªï¼ˆDOIãƒ»OpenAlex ã‚­ãƒ¼ã¯é™¤å¤–ï¼‰
      const oaIds = oaJson.ids || {};
      Object.entries(oaIds).forEach(([key, value]) => {
        const upperKey = key.toUpperCase();
        if (upperKey === 'DOI' || upperKey === 'OPENALEX') return;
        if (!VALID_RELATION_ID_TYPES.has(upperKey)) return;
        relations.push({
          subitem_relation_type: 'isIdenticalTo',
          subitem_relation_type_id: {
            subitem_relation_type_id_text: value,
            subitem_relation_type_select: upperKey,
          },
          subitem_relation_name: [],
        });
      });
      return relations;
    })(),

    // ----- æ™‚é–“çš„ç¯„å›²ï¼ˆç©ºï¼‰-----
    item_30002_temporal19: [],

    // ----- ä½ç½®æƒ…å ±ï¼ˆç©ºï¼‰-----
    item_30002_geolocation20: [],

    // ----- åŠ©æˆæƒ…å ± -----
    item_30002_funding_reference21: await buildFunders(crJson.funder),

    // ----- åéŒ²ç‰©è­˜åˆ¥å­ -----
    item_30002_source_identifier22: sourceIdentifiers,

    // ----- åéŒ²ç‰©å -----
    item_30002_source_title23: containerTitle
      ? [{ subitem_source_title: containerTitle, subitem_source_title_language: 'en' }]
      : [],

    // ----- å·» -----
    item_30002_volume_number24: { subitem_volume: crJson.volume || '' },

    // ----- å· -----
    item_30002_issue_number25: { subitem_issue: crJson.issue || '' },

    // ----- ãƒšãƒ¼ã‚¸æ•°ï¼ˆç©ºï¼‰-----
    item_30002_number_of_pages26: { subitem_number_of_pages: '' },

    // ----- é–‹å§‹ãƒšãƒ¼ã‚¸ -----
    item_30002_page_start27: { subitem_start_page: pageStart },

    // ----- çµ‚äº†ãƒšãƒ¼ã‚¸ -----
    item_30002_page_end28: { subitem_end_page: pageEnd },

    // ----- æ›¸èªŒæƒ…å ± -----
    item_30002_bibliographic_information29: containerTitle ? {
      bibliographicIssueDates: pubDate
        ? { bibliographicIssueDate: pubDate, bibliographicIssueDateType: 'Issued' }
        : {},
      bibliographicIssueNumber:    crJson.issue   || '',
      bibliographicVolumeNumber:   crJson.volume  || '',
      bibliographicPageStart:      pageStart,
      bibliographicPageEnd:        pageEnd,
      bibliographicNumberOfPages:  '',
      bibliographic_titles: [{
        bibliographic_title:     containerTitle,
        bibliographic_titleLang: 'en',
      }],
    } : null,

    // ----- ä¼šè­°è¨˜è¿°ï¼ˆç©ºï¼‰-----
    item_30002_conference34: [],
  };

  return metadata;
}

// ================================================================
// STEP 5: UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å±¤
// ================================================================

// ===== 5.1 ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾© =====
// type: 'array','object','creator','contributor','relation','funding','biblio'
// fields å†…: k=ã‚­ãƒ¼, l=ãƒ©ãƒ™ãƒ«, t=å…¥åŠ›å‹, o=TITLE_MAPSã‚­ãƒ¼, w=è­¦å‘Šãƒ•ãƒ©ã‚°ã‚­ãƒ¼, ro=èª­å–å°‚ç”¨
const FIELD_DEFS = [
  { key: 'item_30002_title0', label: 'ã‚¿ã‚¤ãƒˆãƒ«', type: 'array',
    fields: [
      { k: 'subitem_title', l: 'ã‚¿ã‚¤ãƒˆãƒ«', t: 'text' },
      { k: 'subitem_title_language', l: 'è¨€èª', t: 'select', o: 'language', w: '_warnLang' },
    ],
    sum: a => a?.[0]?.subitem_title || '' },
  { key: 'item_30002_alternative_title1', label: 'ãã®ä»–ã®ã‚¿ã‚¤ãƒˆãƒ«', type: 'array',
    fields: [
      { k: 'subitem_alternative_title', l: 'ãã®ä»–ã®ã‚¿ã‚¤ãƒˆãƒ«', t: 'text' },
      { k: 'subitem_alternative_title_language', l: 'è¨€èª', t: 'select', o: 'language' },
    ],
    sum: a => a?.[0]?.subitem_alternative_title || '' },
  { key: 'item_30002_creator2', label: 'ä½œæˆè€…', type: 'creator',
    sum: a => { if (!a?.length) return ''; const n = a[0]?.creatorNames?.[0]?.creatorName || ''; return a.length > 1 ? `${n} ä»–${a.length-1}å` : n; } },
  { key: 'item_30002_contributor3', label: 'å¯„ä¸è€…', type: 'contributor',
    sum: a => { if (!a?.length) return ''; const n = a[0]?.contributorNames?.[0]?.contributorName || ''; return a.length > 1 ? `${n} ä»–${a.length-1}å` : n; } },
  { key: 'item_30002_access_rights4', label: 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©', type: 'object',
    fields: [
      { k: 'subitem_access_right', l: 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©', t: 'select', o: 'subitem_access_right', link: { tgt: 'subitem_access_right_uri', map: ACCESS_RIGHTS_MAP } },
      { k: 'subitem_access_right_uri', l: 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©URI', t: 'text', ro: true },
    ],
    sum: o => o?.subitem_access_right || '' },
  { key: 'item_30002_rights6', label: 'æ¨©åˆ©æƒ…å ±', type: 'array',
    fields: [
      { k: 'subitem_rights', l: 'æ¨©åˆ©æƒ…å ±', t: 'text' },
      { k: 'subitem_rights_language', l: 'è¨€èª', t: 'select', o: 'language' },
      { k: 'subitem_rights_resource', l: 'æ¨©åˆ©æƒ…å ±ãƒªã‚½ãƒ¼ã‚¹URL', t: 'text' },
    ],
    sum: a => a?.[0]?.subitem_rights || a?.[0]?.subitem_rights_resource || '' },
  { key: 'item_30002_rights_holder7', label: 'æ¨©åˆ©è€…æƒ…å ±', type: 'rightsHolder',
    sum: a => { if (!a?.length) return ''; const n = a[0]?.rightHolderNames?.[0]?.rightHolderName || ''; return a.length > 1 ? `${n} ä»–${a.length-1}ä»¶` : n; } },
  { key: 'item_30002_subject8', label: 'ä¸»é¡Œ', type: 'array',
    fields: [
      { k: 'subitem_subject', l: 'ä¸»é¡Œ', t: 'text' },
      { k: 'subitem_subject_language', l: 'è¨€èª', t: 'select', o: 'language' },
      { k: 'subitem_subject_scheme', l: 'ä¸»é¡ŒScheme', t: 'text' },
      { k: 'subitem_subject_uri', l: 'ä¸»é¡ŒURI', t: 'text' },
    ],
    sum: a => { if (!a?.length) return ''; const f = a[0]?.subitem_subject || ''; return a.length > 1 ? `${f} ä»–${a.length-1}ä»¶` : f; } },
  { key: 'item_30002_description9', label: 'å†…å®¹è¨˜è¿°', type: 'array',
    fields: [
      { k: 'subitem_description', l: 'å†…å®¹è¨˜è¿°', t: 'textarea' },
      { k: 'subitem_description_language', l: 'è¨€èª', t: 'select', o: 'language' },
      { k: 'subitem_description_type', l: 'å†…å®¹è¨˜è¿°ã‚¿ã‚¤ãƒ—', t: 'select', o: 'subitem_description_type' },
    ],
    sum: a => { const d = a?.[0]?.subitem_description || ''; return d.length > 50 ? d.substring(0,50)+'â€¦' : d; } },
  { key: 'item_30002_publisher10', label: 'å‡ºç‰ˆè€…', type: 'array',
    fields: [
      { k: 'subitem_publisher', l: 'å‡ºç‰ˆè€…', t: 'text' },
      { k: 'subitem_publisher_language', l: 'è¨€èª', t: 'select', o: 'language' },
    ],
    sum: a => a?.[0]?.subitem_publisher || '' },
  { key: 'item_30002_date11', label: 'æ—¥ä»˜', type: 'array',
    fields: [
      { k: 'subitem_date_issued_datetime', l: 'æ—¥ä»˜', t: 'text' },
      { k: 'subitem_date_issued_type', l: 'æ—¥ä»˜ã‚¿ã‚¤ãƒ—', t: 'select', o: 'subitem_date_issued_type' },
    ],
    sum: a => a?.[0] ? `${a[0].subitem_date_issued_datetime||''} (${a[0].subitem_date_issued_type||''})` : '' },
  { key: 'item_30002_language12', label: 'è¨€èª', type: 'array',
    fields: [{ k: 'subitem_language', l: 'è¨€èª', t: 'select', o: 'subitem_language' }],
    sum: a => a?.[0]?.subitem_language || '' },
  { key: 'item_30002_resource_type13', label: 'è³‡æºã‚¿ã‚¤ãƒ—', type: 'object',
    fields: [
      { k: 'resourcetype', l: 'è³‡æºã‚¿ã‚¤ãƒ—', t: 'select', o: 'resourcetype', link: { tgt: 'resourceuri', map: RESOURCE_TYPE_MAP } },
      { k: 'resourceuri', l: 'è³‡æºã‚¿ã‚¤ãƒ—è­˜åˆ¥å­', t: 'text', ro: true },
    ],
    sum: o => o?.resourcetype || '' },
  { key: 'item_30002_version14', label: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±', type: 'object',
    fields: [{ k: 'subitem_version', l: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±', t: 'text' }],
    sum: o => o?.subitem_version || '' },
  { key: 'item_30002_version_type15', label: 'å‡ºç‰ˆã‚¿ã‚¤ãƒ—', type: 'object',
    fields: [
      { k: 'subitem_version_type', l: 'å‡ºç‰ˆã‚¿ã‚¤ãƒ—', t: 'select', o: 'subitem_version_type' },
      { k: 'subitem_version_resource', l: 'å‡ºç‰ˆã‚¿ã‚¤ãƒ—ãƒªã‚½ãƒ¼ã‚¹', t: 'text' },
    ],
    sum: o => o?.subitem_version_type || '' },
  { key: 'item_30002_identifier16', label: 'è­˜åˆ¥å­', type: 'array',
    fields: [
      { k: 'subitem_identifier_uri', l: 'è­˜åˆ¥å­', t: 'text' },
      { k: 'subitem_identifier_type', l: 'è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—', t: 'select', o: 'subitem_identifier_type' },
    ],
    sum: a => a?.[0]?.subitem_identifier_uri || '' },
  { key: 'item_30002_identifier_registration17', label: 'IDç™»éŒ²', type: 'object',
    fields: [
      { k: 'subitem_identifier_reg_text', l: 'IDç™»éŒ²ãƒ†ã‚­ã‚¹ãƒˆ', t: 'text' },
      { k: 'subitem_identifier_reg_type', l: 'IDç™»éŒ²ã‚¿ã‚¤ãƒ—', t: 'text' },
    ],
    sum: o => o?.subitem_identifier_reg_text || '' },
  { key: 'item_30002_relation18', label: 'é–¢é€£æƒ…å ±', type: 'relation',
    sum: a => a?.[0]?.subitem_relation_type_id?.subitem_relation_type_id_text || '' },
  { key: 'item_30002_temporal19', label: 'æ™‚é–“çš„ç¯„å›²', type: 'array',
    fields: [
      { k: 'subitem_temporal_text', l: 'æ™‚é–“çš„ç¯„å›²', t: 'text' },
      { k: 'subitem_temporal_language', l: 'è¨€èª', t: 'select', o: 'language' },
    ],
    sum: a => a?.[0]?.subitem_temporal_text || '' },
  { key: 'item_30002_geolocation20', label: 'ä½ç½®æƒ…å ±', type: 'geolocation',
    sum: a => { if (!a?.length) return ''; const p = a[0]?.subitem_geolocation_place?.[0]?.subitem_geolocation_place_text || ''; return a.length > 1 ? `${p} ä»–${a.length-1}ä»¶` : p; } },
  { key: 'item_30002_funding_reference21', label: 'åŠ©æˆæƒ…å ±', type: 'funding',
    sum: a => { if (!a?.length) return ''; const n = a[0]?.subitem_funder_names?.[0]?.subitem_funder_name || ''; return a.length > 1 ? `${n} ä»–${a.length-1}ä»¶` : n; } },
  { key: 'item_30002_source_identifier22', label: 'åéŒ²ç‰©è­˜åˆ¥å­', type: 'array',
    fields: [
      { k: 'subitem_source_identifier', l: 'åéŒ²ç‰©è­˜åˆ¥å­', t: 'text' },
      { k: 'subitem_source_identifier_type', l: 'åéŒ²ç‰©è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—', t: 'select', o: 'subitem_source_identifier_type' },
    ],
    sum: a => a?.map(i => `${i.subitem_source_identifier_type||''}:${i.subitem_source_identifier||''}`).join(', ') || '' },
  { key: 'item_30002_source_title23', label: 'åéŒ²ç‰©å', type: 'array',
    fields: [
      { k: 'subitem_source_title', l: 'åéŒ²ç‰©å', t: 'text' },
      { k: 'subitem_source_title_language', l: 'è¨€èª', t: 'select', o: 'language' },
    ],
    sum: a => a?.[0]?.subitem_source_title || '' },
  { key: 'item_30002_volume_number24', label: 'å·»', type: 'object',
    fields: [{ k: 'subitem_volume', l: 'å·»', t: 'text' }],
    sum: o => o?.subitem_volume || '' },
  { key: 'item_30002_issue_number25', label: 'å·', type: 'object',
    fields: [{ k: 'subitem_issue', l: 'å·', t: 'text' }],
    sum: o => o?.subitem_issue || '' },
  { key: 'item_30002_number_of_pages26', label: 'ãƒšãƒ¼ã‚¸æ•°', type: 'object',
    fields: [{ k: 'subitem_number_of_pages', l: 'ãƒšãƒ¼ã‚¸æ•°', t: 'text' }],
    sum: o => o?.subitem_number_of_pages || '' },
  { key: 'item_30002_page_start27', label: 'é–‹å§‹ãƒšãƒ¼ã‚¸', type: 'object',
    fields: [{ k: 'subitem_start_page', l: 'é–‹å§‹ãƒšãƒ¼ã‚¸', t: 'text' }],
    sum: o => o?.subitem_start_page || '' },
  { key: 'item_30002_page_end28', label: 'çµ‚äº†ãƒšãƒ¼ã‚¸', type: 'object',
    fields: [{ k: 'subitem_end_page', l: 'çµ‚äº†ãƒšãƒ¼ã‚¸', t: 'text' }],
    sum: o => o?.subitem_end_page || '' },
  { key: 'item_30002_bibliographic_information29', label: 'æ›¸èªŒæƒ…å ±', type: 'biblio',
    sum: o => o?.bibliographic_titles?.[0]?.bibliographic_title || '' },
  { key: 'item_30002_conference34', label: 'ä¼šè­°è¨˜è¿°', type: 'conference',
    sum: a => { if (!a?.length) return ''; const n = a[0]?.subitem_conference_names?.[0]?.subitem_conference_name || ''; return a.length > 1 ? `${n} ä»–${a.length-1}ä»¶` : n; } },
];

// ===== STEP 6: å‹•çš„å‰Šé™¤ãƒ˜ãƒ«ãƒ‘ãƒ¼ =====

function removeNestedItemEl(el) {
  const parent = el.parentElement;
  el.remove();
  renumberItems(parent);
}

function renumberItems(container) {
  container.querySelectorAll(':scope > .nested-item').forEach((item, idx) => {
    const lbl = item.querySelector(':scope > .item-header .item-label');
    if (lbl) lbl.textContent = lbl.textContent.replace(/\[\d+\]/, `[${idx}]`);
  });
}

// ===== 5.2 DOMç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ =====

// ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
function createSection(key, label, summaryText) {
  const section = document.createElement('div');
  section.className = 'field-section';
  section.dataset.key = key;
  const header = document.createElement('div');
  header.className = 'section-header';
  const jpcoarUrl = JPCOAR_LINKS[key];
  const labelHtml = jpcoarUrl
    ? `<a href="${jpcoarUrl}" target="_blank">${label}</a>`
    : label;
  header.innerHTML = `<span class="toggle-icon">â–¼</span>${labelHtml}<span class="summary">${summaryText ? 'ï¼ˆ'+summaryText+'ï¼‰' : ''}</span>`;
  header.onclick = function() { toggleAccordion(this); };
  const content = document.createElement('div');
  content.className = 'accordion-content';
  section.appendChild(header);
  section.appendChild(content);
  return { section, content, header };
}

// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡Œ
function createFieldRow(label, value, inputType, selectOptsKey, extra) {
  extra = extra || {};
  const row = document.createElement('div');
  row.className = 'field-row';
  if (extra.fieldKey) row.dataset.fieldKey = extra.fieldKey;
  const lbl = document.createElement('span');
  lbl.className = 'field-label';
  lbl.textContent = label;
  row.appendChild(lbl);

  // å‚ç…§å€¤ï¼ˆãƒ’ãƒ³ãƒˆï¼‰ã‚»ãƒ«: APIå–å¾—æ™‚ã®ã¿ã€éç©ºãƒ»éreadonlyãƒ»éselectãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¡¨ç¤º
  const hintVal = extra.hintOverride || value;
  if (showHints && hintVal && !extra.readonly && inputType !== 'select') {
    const hint = document.createElement('span');
    hint.className = 'hint-cell';
    hint.title = String(hintVal);
    hint.innerHTML = renderHint(hintVal);
    row.appendChild(hint);
  }

  if (inputType === 'textarea') {
    const ta = document.createElement('textarea');
    ta.value = value || '';
    row.appendChild(ta);
  } else if (inputType === 'select' && selectOptsKey) {
    const opts = TITLE_MAPS[selectOptsKey] || [];
    const sel = buildSelect(opts, value || '', extra.onChange || null);
    row.appendChild(sel);
  } else {
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.value = value || '';
    if (extra.readonly) inp.readOnly = true;
    row.appendChild(inp);
  }

  if (extra.warn) {
    const badge = document.createElement('span');
    badge.className = 'warn-badge';
    badge.title = extra.warnTitle || 'è¦ç¢ºèª';
    badge.textContent = 'âš  è¦ç¢ºèª';
    row.appendChild(badge);
  }
  return row;
}

// ãƒã‚¹ãƒˆé …ç›®ï¼ˆLevel 1+ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
function createNestedItem(label, level) {
  const item = document.createElement('div');
  item.className = `nested-item level-${level}`;
  const icons = ['', 'ğŸ“¦', 'ğŸ“', 'ğŸ“', 'Â·'];
  const icon = icons[Math.min(level, 4)] || '';
  const header = document.createElement('div');
  header.className = 'item-header';
  header.innerHTML = `<span class="toggle-icon">â–¼</span>${icon ? '<span class="level-icon">'+icon+'</span>' : ''}<span class="item-label">${label}</span><span class="item-summary"></span>`;
  const delBtn = document.createElement('button');
  delBtn.className = 'btn-delete';
  delBtn.textContent = 'âˆ’ å‰Šé™¤';
  delBtn.onclick = function(e) { e.stopPropagation(); if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) removeNestedItemEl(item); };
  header.appendChild(delBtn);
  header.onclick = function() { toggleAccordion(this); };
  const content = document.createElement('div');
  content.className = 'item-content';
  item.appendChild(header);
  item.appendChild(content);
  return { item, content, header };
}

// ãƒã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆLevel 2+ ã‚µãƒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
// onAdd: é–¢æ•°ã‚’æ¸¡ã™ã¨è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã« onAdd(content) ã‚’å‘¼ã³å‡ºã™
//        false ã‚’æ¸¡ã™ã¨è¿½åŠ ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
//        çœç•¥/null ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ãŒ noop
function createNestedSectionHeader(label, level, onAdd) {
  const wrapper = document.createElement('div');
  wrapper.className = `nested-item level-${level}`;
  const icons = ['', 'ğŸ“¦', 'ğŸ“', 'ğŸ“', 'Â·'];
  const icon = icons[Math.min(level, 4)] || '';
  const header = document.createElement('div');
  header.className = 'nested-section-header';
  header.innerHTML = `<span class="toggle-icon">â–¼</span>${icon ? '<span class="level-icon">'+icon+'</span>' : ''}<span>${label}</span>`;
  const content = document.createElement('div');
  content.className = 'nested-section-content';
  if (onAdd !== false) {
    const addBtn = document.createElement('button');
    addBtn.className = 'btn-add';
    addBtn.textContent = '+ è¿½åŠ ';
    addBtn.onclick = onAdd
      ? function(e) { e.stopPropagation(); onAdd(content); }
      : function(e) { e.stopPropagation(); };
    header.appendChild(addBtn);
  }
  header.onclick = function() { toggleAccordion(this); };
  wrapper.appendChild(header);
  wrapper.appendChild(content);
  return { wrapper, content };
}

// è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆonAdd ã‚’æ¸¡ã™ã¨ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å®Ÿè¡Œï¼‰
function createAddButton(label, onAdd) {
  const btn = document.createElement('button');
  btn.className = 'btn-add';
  btn.style.cssText = 'margin: 8px 16px; display: block;';
  btn.textContent = `+ ${label}ã‚’è¿½åŠ `;
  btn.onclick = onAdd
    ? function(e) { e.stopPropagation(); onAdd(); }
    : function(e) { e.stopPropagation(); };
  return btn;
}

// ã‚¨ãƒ³ãƒˆãƒªã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆå§“åãƒ»è­˜åˆ¥å­ç­‰ã‚µãƒ–é…åˆ—1ä»¶ã‚’å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãã§ãƒ©ãƒƒãƒ—ï¼‰
function createEntryGroup() {
  const grp = document.createElement('div');
  grp.className = 'entry-group';
  const delBtn = document.createElement('button');
  delBtn.className = 'btn-delete btn-delete-inline';
  delBtn.textContent = 'âˆ’ å‰Šé™¤';
  delBtn.onclick = function(e) { e.stopPropagation(); if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) grp.remove(); };
  return { grp, delBtn };
}

// FIELD_DEFS ã® fields å®šç¾©ã‹ã‚‰1ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡Œç¾¤ã‚’ç”Ÿæˆ
function renderItemFields(itemData, fieldsDef, container) {
  for (const f of fieldsDef) {
    if (f.t === 'nested') continue; // nested ã¯å€‹åˆ¥å‡¦ç†
    const val = itemData[f.k] || '';
    const isWarn = f.w && itemData[f.w];
    const warnTitle = f.w === '_warnLang' ? 'ä»®ã«è‹±èªã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
                    : f.w === '_warnOrcid' ? 'OpenAlexã‹ã‚‰å–å¾—ã—ãŸå€¤ã§ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
                    : 'è¦ç¢ºèª';
    let onChange = null;
    if (f.link) {
      onChange = (newVal) => {
        const parent = container.closest('.accordion-content, .item-content') || container;
        const targetRow = parent.querySelector(`[data-field-key="${f.link.tgt}"]`);
        if (targetRow) {
          const inp = targetRow.querySelector('input');
          if (inp) inp.value = f.link.map[newVal] || '';
        }
      };
    }
    const row = createFieldRow(f.l, val, f.t, f.o, {
      fieldKey: f.k,
      readonly: f.ro,
      warn: isWarn,
      warnTitle,
      onChange,
      hintOverride: itemData._ncidUrl && f.k === 'subitem_source_identifier' ? itemData._ncidUrl : null,
    });
    container.appendChild(row);
  }
}

// ===== 5.3 æ±ç”¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ =====

// é…åˆ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
function renderArrayField(def, items) {
  const arr = Array.isArray(items) ? items : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  if (!def.fields || !def.fields.length) {
    if (!arr.length) {
      const msg = document.createElement('div');
      msg.style.cssText = 'padding:8px 16px;color:#999;font-size:0.85em';
      msg.textContent = 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
      content.appendChild(msg);
    }
    content.appendChild(createAddButton(def.label));
    return section;
  }

  arr.forEach((item, idx) => {
    const firstVal = item[def.fields[0].k] || '';
    const label = `${def.label}[${idx}]${firstVal ? ': '+firstVal.substring(0,40) : ''}`;
    const { item: nestedItem, content: itemContent } = createNestedItem(label, 1);
    renderItemFields(item, def.fields, itemContent);
    content.appendChild(nestedItem);
  });

  content.appendChild(createAddButton(def.label, () => {
    const newItem = {};
    def.fields.forEach(f => { if (f.t !== 'nested') newItem[f.k] = ''; });
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const firstVal = '';
    const label = `${def.label}[${idx}]`;
    const { item: nestedItem, content: itemContent } = createNestedItem(label, 1);
    renderItemFields(newItem, def.fields, itemContent);
    content.insertBefore(nestedItem, content.lastChild);
  }));
  return section;
}

// ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
function renderObjectField(def, obj) {
  const data = obj || {};
  const summaryText = def.sum(data);
  const { section, content } = createSection(def.key, def.label, summaryText);
  renderItemFields(data, def.fields, content);
  return section;
}

// ===== 5.4 å°‚ç”¨ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ =====

// ----- ä½œæˆè€…/å¯„ä¸è€…: 1äººåˆ†ã®DOMç”Ÿæˆ -----
function renderOnePerson(person, idx, keys) {
  const {
    def, isCreator, typeLabel, typeKey, typeSelectOpts,
    namesLabel, namesKey, nameKey, nameLangKey, nameTypeKey,
    affKey, affLabel, affNameKey, affNameField, affNameLangField,
    affIdKey, affIdField, affIdSchemeField, affIdUriField,
  } = keys;

  const dispName = person[namesKey]?.[0]?.[nameKey] || '';
  const itemLabel = `${def.label}[${idx}]${dispName ? ': '+dispName : ''}`;
  const { item: personItem, content: personContent } = createNestedItem(itemLabel, 1);

  // ã‚¿ã‚¤ãƒ—
  if (typeSelectOpts) {
    personContent.appendChild(createFieldRow(typeLabel, person[typeKey] || '', 'select', typeSelectOpts, { fieldKey: typeKey }));
  } else {
    personContent.appendChild(createFieldRow(typeLabel, person[typeKey] || '', 'text', null, { fieldKey: typeKey }));
  }

  // å§“å
  const { wrapper: namesWrap, content: namesCont } = createNestedSectionHeader(namesLabel, 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('å§“å', '', 'text', null, { fieldKey: nameKey }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: nameLangKey }));
    grp.appendChild(createFieldRow('åå‰ã‚¿ã‚¤ãƒ—', '', 'select', 'creatorNameType', { fieldKey: nameTypeKey }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (person[namesKey] || []).forEach(n => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('å§“å', n[nameKey] || '', 'text', null, { fieldKey: nameKey }));
    grp.appendChild(createFieldRow('è¨€èª', n[nameLangKey] || '', 'select', 'language', {
      fieldKey: nameLangKey, warn: n._warnLang, warnTitle: 'ä»®ã«è‹±èªã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
    }));
    grp.appendChild(createFieldRow('åå‰ã‚¿ã‚¤ãƒ—', n[nameTypeKey] || '', 'select', 'creatorNameType', { fieldKey: nameTypeKey }));
    grp.appendChild(delBtn);
    namesCont.appendChild(grp);
  });
  personContent.appendChild(namesWrap);

  // å§“
  const familyLabel = isCreator ? 'ä½œæˆè€…å§“' : 'å¯„ä¸è€…å§“';
  const { wrapper: famWrap, content: famCont } = createNestedSectionHeader(familyLabel, 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('å§“', '', 'text', null, { fieldKey: 'familyName' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'familyNameLang' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (person.familyNames || []).forEach(fn => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('å§“', fn.familyName || '', 'text', null, { fieldKey: 'familyName' }));
    grp.appendChild(createFieldRow('è¨€èª', fn.familyNameLang || '', 'select', 'language', {
      fieldKey: 'familyNameLang', warn: fn._warnLang, warnTitle: 'ä»®ã«è‹±èªã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
    }));
    grp.appendChild(delBtn);
    famCont.appendChild(grp);
  });
  personContent.appendChild(famWrap);

  // å
  const givenLabel = isCreator ? 'ä½œæˆè€…å' : 'å¯„ä¸è€…å';
  const { wrapper: givWrap, content: givCont } = createNestedSectionHeader(givenLabel, 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('å', '', 'text', null, { fieldKey: 'givenName' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'givenNameLang' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (person.givenNames || []).forEach(gn => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('å', gn.givenName || '', 'text', null, { fieldKey: 'givenName' }));
    grp.appendChild(createFieldRow('è¨€èª', gn.givenNameLang || '', 'select', 'language', {
      fieldKey: 'givenNameLang', warn: gn._warnLang, warnTitle: 'ä»®ã«è‹±èªã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
    }));
    grp.appendChild(delBtn);
    givCont.appendChild(grp);
  });
  personContent.appendChild(givWrap);

  // è­˜åˆ¥å­ï¼ˆORCIDç­‰ï¼‰
  const idLabel = isCreator ? 'ä½œæˆè€…è­˜åˆ¥å­' : 'å¯„ä¸è€…è­˜åˆ¥å­';
  const { wrapper: idWrap, content: idCont } = createNestedSectionHeader(idLabel, 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('è­˜åˆ¥å­', '', 'text', null, { fieldKey: 'nameIdentifier' }));

    const addSearchBtn = document.createElement('button');
    addSearchBtn.textContent = 'CiNiiã§æ¤œç´¢';
    addSearchBtn.className = 'btn-add';
    addSearchBtn.style.marginLeft = '8px';
    addSearchBtn.style.display = 'none';
    addSearchBtn.onclick = (e) => {
      e.preventDefault();
      const family = person.familyNames?.[0]?.familyName || '';
      const given = person.givenNames?.[0]?.givenName || '';
      const searchName = (family && given) ? `${family} ${given}`
        : (person.creatorNames?.[0]?.creatorName || person.contributorNames?.[0]?.contributorName || '');
      if (searchName) {
        window.open(`https://cir.nii.ac.jp/researchers?q=${encodeURIComponent(searchName)}`, '_blank');
      } else {
        alert('è‘—è€…åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
    };

    const onAddSchemeChange = (val) => {
      const uriInput = grp.querySelector('[data-field-key="nameIdentifierURI"] input');
      if (val === 'CiNii' && uriInput && !uriInput.value) {
        uriInput.value = 'https://ci.nii.ac.jp/nrid/';
      }
      addSearchBtn.style.display = val === 'CiNii' ? '' : 'none';
    };

    grp.appendChild(createFieldRow('Scheme', '', 'select', 'nameIdentifierScheme', {
      fieldKey: 'nameIdentifierScheme', onChange: onAddSchemeChange
    }));
    grp.appendChild(createFieldRow('URI', '', 'text', null, { fieldKey: 'nameIdentifierURI' }));
    grp.appendChild(addSearchBtn);
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (person.nameIdentifiers || []).forEach(ni => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('è­˜åˆ¥å­', ni.nameIdentifier || '', 'text', null, { fieldKey: 'nameIdentifier' }));

    // CiNiiæ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆScheme ãŒ CiNii ã®ã¨ãã®ã¿è¡¨ç¤ºï¼‰
    const searchBtn = document.createElement('button');
    searchBtn.textContent = 'CiNiiã§æ¤œç´¢';
    searchBtn.className = 'btn-add';
    searchBtn.style.marginLeft = '8px';
    searchBtn.style.display = ni.nameIdentifierScheme === 'CiNii' ? '' : 'none';
    searchBtn.onclick = (e) => {
      e.preventDefault();
      const family = person.familyNames?.[0]?.familyName || '';
      const given = person.givenNames?.[0]?.givenName || '';
      const searchName = (family && given) ? `${family} ${given}`
        : (person.creatorNames?.[0]?.creatorName || person.contributorNames?.[0]?.contributorName || '');
      if (searchName) {
        window.open(`https://cir.nii.ac.jp/researchers?q=${encodeURIComponent(searchName)}`, '_blank');
      } else {
        alert('è‘—è€…åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
    };

    // Scheme onChange: CiNiié¸æŠæ™‚ã«URIè‡ªå‹•è¨­å®š + æ¤œç´¢ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡æ›¿
    const onSchemeChange = (val) => {
      const uriInput = grp.querySelector('[data-field-key="nameIdentifierURI"] input');
      if (val === 'CiNii' && uriInput && !uriInput.value) {
        uriInput.value = 'https://ci.nii.ac.jp/nrid/';
      }
      searchBtn.style.display = val === 'CiNii' ? '' : 'none';
    };

    grp.appendChild(createFieldRow('Scheme', ni.nameIdentifierScheme || '', 'select', 'nameIdentifierScheme', {
      fieldKey: 'nameIdentifierScheme', onChange: onSchemeChange
    }));
    grp.appendChild(createFieldRow('URI', ni.nameIdentifierURI || '', 'text', null, {
      fieldKey: 'nameIdentifierURI', warn: ni._warnOrcid, warnTitle: 'OpenAlexã‹ã‚‰å–å¾—ã—ãŸå€¤ã§ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
    }));
    grp.appendChild(searchBtn);
    grp.appendChild(delBtn);
    idCont.appendChild(grp);
  });
  personContent.appendChild(idWrap);

  // æ‰€å±
  const { wrapper: affWrap, content: affCont } = createNestedSectionHeader(affLabel, 2, (cont) => {
    const ai = cont.querySelectorAll(':scope > .nested-item').length;
    const emptyAff = {
      [affNameKey]: [{ [affNameField]: '', [affNameLangField]: '' }],
      [affIdKey]: [],
    };
    cont.appendChild(renderOneAffiliation(emptyAff, ai, keys));
  });
  (person[affKey] || []).forEach((aff, ai) => {
    affCont.appendChild(renderOneAffiliation(aff, ai, keys));
  });
  personContent.appendChild(affWrap);

  return personItem;
}

// ----- æ‰€å±æ©Ÿé–¢: 1ä»¶åˆ†ã®DOMç”Ÿæˆ -----
function renderOneAffiliation(aff, ai, keys) {
  const {
    affLabel, affNameKey, affNameField, affNameLangField,
    affIdKey, affIdField, affIdSchemeField, affIdUriField,
  } = keys;

  const affDispName = aff[affNameKey]?.[0]?.[affNameField] || '';
  const { item: affItem, content: affItemCont } = createNestedItem(`${affLabel}[${ai}]${affDispName ? ': '+affDispName : ''}`, 2);

  // æ‰€å±æ©Ÿé–¢å
  const { wrapper: anWrap, content: anCont } = createNestedSectionHeader('æ‰€å±æ©Ÿé–¢å', 3, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('æ‰€å±æ©Ÿé–¢å', '', 'text', null, { fieldKey: affNameField }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: affNameLangField }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (aff[affNameKey] || []).forEach(an => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('æ‰€å±æ©Ÿé–¢å', an[affNameField] || '', 'text', null, { fieldKey: affNameField }));
    grp.appendChild(createFieldRow('è¨€èª', an[affNameLangField] || '', 'select', 'language', {
      fieldKey: affNameLangField, warn: an._warnLang, warnTitle: 'ä»®ã«è‹±èªã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚æ­£ç¢ºã‹ç¢ºèªã—ã¦ãã ã•ã„'
    }));
    grp.appendChild(delBtn);
    anCont.appendChild(grp);
  });
  affItemCont.appendChild(anWrap);

  // æ‰€å±æ©Ÿé–¢è­˜åˆ¥å­
  const { wrapper: aiWrap, content: aiCont } = createNestedSectionHeader('æ‰€å±æ©Ÿé–¢è­˜åˆ¥å­', 3, (cont) => {
    const aidx = cont.querySelectorAll(':scope > .nested-item').length;
    const { item: aidItem, content: aidContent } = createNestedItem(`æ‰€å±æ©Ÿé–¢è­˜åˆ¥å­[${aidx}]`, 4);
    aidContent.appendChild(createFieldRow('è­˜åˆ¥å­', '', 'text', null, { fieldKey: affIdField }));
    aidContent.appendChild(createFieldRow('Scheme', '', 'select', 'affiliationNameIdentifierScheme', { fieldKey: affIdSchemeField }));
    aidContent.appendChild(createFieldRow('URI', '', 'text', null, { fieldKey: affIdUriField }));
    cont.appendChild(aidItem);
  });
  (aff[affIdKey] || []).forEach((aid, aidx) => {
    const { item: aidItem, content: aidContent } = createNestedItem(`æ‰€å±æ©Ÿé–¢è­˜åˆ¥å­[${aidx}]`, 4);
    aidContent.appendChild(createFieldRow('è­˜åˆ¥å­', aid[affIdField] || '', 'text', null, { fieldKey: affIdField }));
    aidContent.appendChild(createFieldRow('Scheme', aid[affIdSchemeField] || '', 'select', 'affiliationNameIdentifierScheme', { fieldKey: affIdSchemeField }));
    aidContent.appendChild(createFieldRow('URI', aid[affIdUriField] || '', 'text', null, { fieldKey: affIdUriField }));
    aiCont.appendChild(aidItem);
  });
  affItemCont.appendChild(aiWrap);

  return affItem;
}

// ----- ä½œæˆè€…/å¯„ä¸è€… å…±é€š -----
function renderPersonField(def, persons, isCreator) {
  const arr = Array.isArray(persons) ? persons : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  const keys = {
    def, isCreator,
    typeLabel: isCreator ? 'ä½œæˆè€…ã‚¿ã‚¤ãƒ—' : 'å¯„ä¸è€…ã‚¿ã‚¤ãƒ—',
    typeKey: isCreator ? 'creatorType' : 'contributorType',
    typeSelectOpts: isCreator ? null : 'contributorType',
    namesLabel: isCreator ? 'ä½œæˆè€…å§“å' : 'å¯„ä¸è€…å§“å',
    namesKey: isCreator ? 'creatorNames' : 'contributorNames',
    nameKey: isCreator ? 'creatorName' : 'contributorName',
    nameLangKey: isCreator ? 'creatorNameLang' : 'lang',
    nameTypeKey: isCreator ? 'creatorNameType' : 'nameType',
    affKey: isCreator ? 'creatorAffiliations' : 'contributorAffiliations',
    affLabel: isCreator ? 'ä½œæˆè€…æ‰€å±' : 'å¯„ä¸è€…æ‰€å±',
    affNameKey: isCreator ? 'affiliationNames' : 'contributorAffiliationNames',
    affNameField: isCreator ? 'affiliationName' : 'contributorAffiliationName',
    affNameLangField: isCreator ? 'affiliationNameLang' : 'contributorAffiliationNameLang',
    affIdKey: isCreator ? 'affiliationNameIdentifiers' : 'contributorAffiliationNameIdentifiers',
    affIdField: isCreator ? 'affiliationNameIdentifier' : 'contributorAffiliationNameIdentifier',
    affIdSchemeField: isCreator ? 'affiliationNameIdentifierScheme' : 'contributorAffiliationScheme',
    affIdUriField: isCreator ? 'affiliationNameIdentifierURI' : 'contributorAffiliationURI',
  };

  arr.forEach((person, idx) => {
    content.appendChild(renderOnePerson(person, idx, keys));
  });

  content.appendChild(createAddButton(def.label, () => {
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const emptyPerson = {
      [keys.typeKey]: '',
      [keys.namesKey]: [{ [keys.nameKey]: '', [keys.nameLangKey]: '', [keys.nameTypeKey]: '' }],
      familyNames: [{ familyName: '', familyNameLang: '' }],
      givenNames: [{ givenName: '', givenNameLang: '' }],
      nameIdentifiers: [],
      [keys.affKey]: [],
    };
    content.insertBefore(renderOnePerson(emptyPerson, idx, keys), content.lastChild);
  }));

  return section;
}

// ----- é–¢é€£æƒ…å ± -----
function renderRelationField(def, relations) {
  const arr = Array.isArray(relations) ? relations : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  arr.forEach((rel, idx) => {
    const idText = rel.subitem_relation_type_id?.subitem_relation_type_id_text || '';
    const itemLabel = `${def.label}[${idx}]${idText ? ': '+idText.substring(0,40) : ''}`;
    const { item: relItem, content: relContent } = createNestedItem(itemLabel, 1);

    relContent.appendChild(createFieldRow('é–¢é€£ã‚¿ã‚¤ãƒ—', rel.subitem_relation_type || '', 'select', 'subitem_relation_type', { fieldKey: 'subitem_relation_type' }));

    // é–¢é€£è­˜åˆ¥å­ï¼ˆfieldsetï¼‰
    const relId = rel.subitem_relation_type_id || {};
    relContent.appendChild(createFieldRow('è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—', relId.subitem_relation_type_select || '', 'select', 'subitem_relation_type_select', { fieldKey: 'subitem_relation_type_select' }));
    relContent.appendChild(createFieldRow('é–¢é€£è­˜åˆ¥å­', relId.subitem_relation_type_id_text || '', 'text', null, { fieldKey: 'subitem_relation_type_id_text' }));

    // é–¢é€£åç§°ï¼ˆé…åˆ—ï¼‰
    const { wrapper: rnWrap, content: rnCont } = createNestedSectionHeader('é–¢é€£åç§°', 2, (cont) => {
      const { grp, delBtn } = createEntryGroup();
      grp.appendChild(createFieldRow('é–¢é€£åç§°', '', 'text', null, { fieldKey: 'subitem_relation_name_text' }));
      grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_relation_name_language' }));
      grp.appendChild(delBtn);
      cont.appendChild(grp);
    });
    (rel.subitem_relation_name || []).forEach(rn => {
      const { grp, delBtn } = createEntryGroup();
      grp.appendChild(createFieldRow('é–¢é€£åç§°', rn.subitem_relation_name_text || '', 'text', null, { fieldKey: 'subitem_relation_name_text' }));
      grp.appendChild(createFieldRow('è¨€èª', rn.subitem_relation_name_language || '', 'select', 'language', { fieldKey: 'subitem_relation_name_language' }));
      grp.appendChild(delBtn);
      rnCont.appendChild(grp);
    });
    relContent.appendChild(rnWrap);

    content.appendChild(relItem);
  });

  content.appendChild(createAddButton(def.label, () => {
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const emptyRel = {
      subitem_relation_type: '',
      subitem_relation_type_id: { subitem_relation_type_select: '', subitem_relation_type_id_text: '' },
      subitem_relation_name: [],
    };
    content.insertBefore(
      (() => {
        const itemLabel = `${def.label}[${idx}]`;
        const { item: relItem, content: relContent } = createNestedItem(itemLabel, 1);
        relContent.appendChild(createFieldRow('é–¢é€£ã‚¿ã‚¤ãƒ—', '', 'select', 'subitem_relation_type', { fieldKey: 'subitem_relation_type' }));
        relContent.appendChild(createFieldRow('è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—', '', 'select', 'subitem_relation_type_select', { fieldKey: 'subitem_relation_type_select' }));
        relContent.appendChild(createFieldRow('é–¢é€£è­˜åˆ¥å­', '', 'text', null, { fieldKey: 'subitem_relation_type_id_text' }));
        const { wrapper: rnWrap, content: rnCont } = createNestedSectionHeader('é–¢é€£åç§°', 2, (cont) => {
          const { grp, delBtn } = createEntryGroup();
          grp.appendChild(createFieldRow('é–¢é€£åç§°', '', 'text', null, { fieldKey: 'subitem_relation_name_text' }));
          grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_relation_name_language' }));
          grp.appendChild(delBtn);
          cont.appendChild(grp);
        });
        relContent.appendChild(rnWrap);
        return relItem;
      })(),
      content.lastChild
    );
  }));
  return section;
}

// ----- 1ä»¶ã®åŠ©æˆæƒ…å ±DOMã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ -----
function renderOneFunder(funder, idx, defLabel) {
  const fName = funder.subitem_funder_names?.[0]?.subitem_funder_name || '';
  const itemLabel = `${defLabel}[${idx}]${fName ? ': '+fName.substring(0,40) : ''}`;
  const { item: fundItem, content: fundContent } = createNestedItem(itemLabel, 1);

  // åŠ©æˆæ©Ÿé–¢åï¼ˆé…åˆ—ï¼‰
  const { wrapper: fnWrap, content: fnCont } = createNestedSectionHeader('åŠ©æˆæ©Ÿé–¢å', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('åŠ©æˆæ©Ÿé–¢å', '', 'text', null, { fieldKey: 'subitem_funder_name' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_funder_name_language' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (funder.subitem_funder_names || []).forEach(fn => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('åŠ©æˆæ©Ÿé–¢å', fn.subitem_funder_name || '', 'text', null, { fieldKey: 'subitem_funder_name' }));
    grp.appendChild(createFieldRow('è¨€èª', fn.subitem_funder_name_language || '', 'select', 'language', { fieldKey: 'subitem_funder_name_language' }));
    grp.appendChild(delBtn);
    fnCont.appendChild(grp);
  });
  fundContent.appendChild(fnWrap);

  // åŠ©æˆæ©Ÿé–¢è­˜åˆ¥å­ï¼ˆfieldsetï¼‰
  const fId = funder.subitem_funder_identifiers || {};
  fundContent.appendChild(createFieldRow('åŠ©æˆæ©Ÿé–¢è­˜åˆ¥å­', fId.subitem_funder_identifier || '', 'text', null, { fieldKey: 'subitem_funder_identifier' }));
  fundContent.appendChild(createFieldRow('è­˜åˆ¥å­ã‚¿ã‚¤ãƒ—', fId.subitem_funder_identifier_type || '', 'select', 'subitem_funder_identifier_type', { fieldKey: 'subitem_funder_identifier_type' }));

  // ç ”ç©¶èª²é¡Œç•ªå·ï¼ˆfieldsetï¼‰
  const aw = funder.subitem_award_numbers || {};
  fundContent.appendChild(createFieldRow('ç ”ç©¶èª²é¡Œç•ªå·', aw.subitem_award_number || '', 'text', null, { fieldKey: 'subitem_award_number' }));
  fundContent.appendChild(createFieldRow('ç ”ç©¶èª²é¡Œç•ªå·URI', aw.subitem_award_uri || '', 'text', null, { fieldKey: 'subitem_award_uri' }));

  // ç ”ç©¶èª²é¡Œåï¼ˆé…åˆ—ï¼‰
  const { wrapper: atWrap, content: atCont } = createNestedSectionHeader('ç ”ç©¶èª²é¡Œå', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('ç ”ç©¶èª²é¡Œå', '', 'text', null, { fieldKey: 'subitem_award_title' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_award_title_language' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (funder.subitem_award_titles || []).forEach(at => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('ç ”ç©¶èª²é¡Œå', at.subitem_award_title || '', 'text', null, { fieldKey: 'subitem_award_title' }));
    grp.appendChild(createFieldRow('è¨€èª', at.subitem_award_title_language || '', 'select', 'language', { fieldKey: 'subitem_award_title_language' }));
    grp.appendChild(delBtn);
    atCont.appendChild(grp);
  });
  fundContent.appendChild(atWrap);

  return fundItem;
}

// ----- åŠ©æˆæƒ…å ± -----
function renderFundingField(def, funders) {
  const arr = Array.isArray(funders) ? funders : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  arr.forEach((funder, idx) => {
    content.appendChild(renderOneFunder(funder, idx, def.label));
  });

  content.appendChild(createAddButton(def.label, () => {
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const emptyFunder = {
      subitem_funder_names: [{ subitem_funder_name: '', subitem_funder_name_language: '' }],
      subitem_funder_identifiers: {},
      subitem_award_numbers: {},
      subitem_award_titles: [],
    };
    content.insertBefore(renderOneFunder(emptyFunder, idx, def.label), content.lastChild);
  }));
  return section;
}

// ----- æ›¸èªŒæƒ…å ± -----
function renderBiblioField(def, obj) {
  const data = obj || {};
  const summaryText = def.sum(data);
  const { section, content } = createSection(def.key, def.label, summaryText);

  if (!obj) {
    const msg = document.createElement('div');
    msg.style.cssText = 'padding:8px 16px;color:#999;font-size:0.85em';
    msg.textContent = 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
    content.appendChild(msg);
    return section;
  }

  // é›‘èªŒåï¼ˆé…åˆ—ï¼‰
  const { wrapper: btWrap, content: btCont } = createNestedSectionHeader('é›‘èªŒå', 2);
  (data.bibliographic_titles || []).forEach(bt => {
    btCont.appendChild(createFieldRow('ã‚¿ã‚¤ãƒˆãƒ«', bt.bibliographic_title || '', 'text', null, { fieldKey: 'bibliographic_title' }));
    btCont.appendChild(createFieldRow('è¨€èª', bt.bibliographic_titleLang || '', 'select', 'language', { fieldKey: 'bibliographic_titleLang' }));
  });
  content.appendChild(btWrap);

  // å·»ãƒ»å·ãƒ»ãƒšãƒ¼ã‚¸
  content.appendChild(createFieldRow('å·»', data.bibliographicVolumeNumber || '', 'text', null, { fieldKey: 'bibliographicVolumeNumber' }));
  content.appendChild(createFieldRow('å·', data.bibliographicIssueNumber || '', 'text', null, { fieldKey: 'bibliographicIssueNumber' }));
  content.appendChild(createFieldRow('é–‹å§‹ãƒšãƒ¼ã‚¸', data.bibliographicPageStart || '', 'text', null, { fieldKey: 'bibliographicPageStart' }));
  content.appendChild(createFieldRow('çµ‚äº†ãƒšãƒ¼ã‚¸', data.bibliographicPageEnd || '', 'text', null, { fieldKey: 'bibliographicPageEnd' }));
  content.appendChild(createFieldRow('ãƒšãƒ¼ã‚¸æ•°', data.bibliographicNumberOfPages || '', 'text', null, { fieldKey: 'bibliographicNumberOfPages' }));

  // ç™ºè¡Œæ—¥ï¼ˆfieldsetï¼‰
  const bd = data.bibliographicIssueDates || {};
  content.appendChild(createFieldRow('ç™ºè¡Œæ—¥', bd.bibliographicIssueDate || '', 'text', null, { fieldKey: 'bibliographicIssueDate' }));
  content.appendChild(createFieldRow('ç™ºè¡Œæ—¥ã‚¿ã‚¤ãƒ—', bd.bibliographicIssueDateType || '', 'select', 'bibliographicIssueDateType', { fieldKey: 'bibliographicIssueDateType' }));

  return section;
}

// ----- æ¨©åˆ©è€…æƒ…å ±: 1ä»¶åˆ†ã®DOMç”Ÿæˆ -----
function renderOneRightsHolder(rh, idx, defLabel) {
  const dispName = rh.rightHolderNames?.[0]?.rightHolderName || '';
  const itemLabel = `${defLabel}[${idx}]${dispName ? ': '+dispName.substring(0,40) : ''}`;
  const { item: rhItem, content: rhCont } = createNestedItem(itemLabel, 1);

  // æ¨©åˆ©è€…åï¼ˆé…åˆ—ï¼‰
  const { wrapper: rnWrap, content: rnCont } = createNestedSectionHeader('æ¨©åˆ©è€…å', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('æ¨©åˆ©è€…å', '', 'text', null, { fieldKey: 'rightHolderName' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'rightHolderLanguage' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (rh.rightHolderNames || []).forEach(rn => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('æ¨©åˆ©è€…å', rn.rightHolderName || '', 'text', null, { fieldKey: 'rightHolderName' }));
    grp.appendChild(createFieldRow('è¨€èª', rn.rightHolderLanguage || '', 'select', 'language', { fieldKey: 'rightHolderLanguage' }));
    grp.appendChild(delBtn);
    rnCont.appendChild(grp);
  });
  rhCont.appendChild(rnWrap);

  // æ¨©åˆ©è€…è­˜åˆ¥å­ï¼ˆé…åˆ—ï¼‰
  const { wrapper: riWrap, content: riCont } = createNestedSectionHeader('æ¨©åˆ©è€…è­˜åˆ¥å­', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('è­˜åˆ¥å­', '', 'text', null, { fieldKey: 'nameIdentifier' }));
    grp.appendChild(createFieldRow('Scheme', '', 'select', 'nameIdentifierScheme', { fieldKey: 'nameIdentifierScheme' }));
    grp.appendChild(createFieldRow('URI', '', 'text', null, { fieldKey: 'nameIdentifierURI' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (rh.nameIdentifiers || []).forEach(ni => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('è­˜åˆ¥å­', ni.nameIdentifier || '', 'text', null, { fieldKey: 'nameIdentifier' }));
    grp.appendChild(createFieldRow('Scheme', ni.nameIdentifierScheme || '', 'select', 'nameIdentifierScheme', { fieldKey: 'nameIdentifierScheme' }));
    grp.appendChild(createFieldRow('URI', ni.nameIdentifierURI || '', 'text', null, { fieldKey: 'nameIdentifierURI' }));
    grp.appendChild(delBtn);
    riCont.appendChild(grp);
  });
  rhCont.appendChild(riWrap);

  return rhItem;
}

// ----- æ¨©åˆ©è€…æƒ…å ± -----
function renderRightsHolderField(def, holders) {
  const arr = Array.isArray(holders) ? holders : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  arr.forEach((rh, idx) => {
    content.appendChild(renderOneRightsHolder(rh, idx, def.label));
  });

  content.appendChild(createAddButton(def.label, () => {
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const emptyRh = {
      rightHolderNames: [{ rightHolderName: '', rightHolderLanguage: '' }],
      nameIdentifiers: [],
    };
    content.insertBefore(renderOneRightsHolder(emptyRh, idx, def.label), content.lastChild);
  }));
  return section;
}

// ----- ä½ç½®æƒ…å ±: 1ä»¶åˆ†ã®DOMç”Ÿæˆ -----
function renderOneGeolocation(geo, idx, defLabel) {
  const placeText = geo.subitem_geolocation_place?.[0]?.subitem_geolocation_place_text || '';
  const itemLabel = `${defLabel}[${idx}]${placeText ? ': '+placeText.substring(0,40) : ''}`;
  const { item: geoItem, content: geoCont } = createNestedItem(itemLabel, 1);

  // ä½ç½®æƒ…å ±ï¼ˆç‚¹ï¼‰
  const pt = geo.subitem_geolocation_point || {};
  const { wrapper: ptWrap, content: ptCont } = createNestedSectionHeader('ä½ç½®æƒ…å ±ï¼ˆç‚¹ï¼‰', 2, false);
  ptCont.appendChild(createFieldRow('çµŒåº¦', pt.subitem_point_longitude || '', 'text', null, { fieldKey: 'subitem_point_longitude' }));
  ptCont.appendChild(createFieldRow('ç·¯åº¦', pt.subitem_point_latitude || '', 'text', null, { fieldKey: 'subitem_point_latitude' }));
  geoCont.appendChild(ptWrap);

  // ä½ç½®æƒ…å ±ï¼ˆç©ºé–“ï¼‰
  const bx = geo.subitem_geolocation_box || {};
  const { wrapper: bxWrap, content: bxCont } = createNestedSectionHeader('ä½ç½®æƒ…å ±ï¼ˆç©ºé–“ï¼‰', 2, false);
  bxCont.appendChild(createFieldRow('è¥¿éƒ¨çµŒåº¦', bx.subitem_west_longitude || '', 'text', null, { fieldKey: 'subitem_west_longitude' }));
  bxCont.appendChild(createFieldRow('æ±éƒ¨çµŒåº¦', bx.subitem_east_longitude || '', 'text', null, { fieldKey: 'subitem_east_longitude' }));
  bxCont.appendChild(createFieldRow('å—éƒ¨ç·¯åº¦', bx.subitem_south_latitude || '', 'text', null, { fieldKey: 'subitem_south_latitude' }));
  bxCont.appendChild(createFieldRow('åŒ—éƒ¨ç·¯åº¦', bx.subitem_north_latitude || '', 'text', null, { fieldKey: 'subitem_north_latitude' }));
  geoCont.appendChild(bxWrap);

  // ä½ç½®æƒ…å ±ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰
  const { wrapper: plWrap, content: plCont } = createNestedSectionHeader('ä½ç½®æƒ…å ±ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('è‡ªç”±è¨˜è¿°', '', 'text', null, { fieldKey: 'subitem_geolocation_place_text' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (geo.subitem_geolocation_place || []).forEach(pl => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('è‡ªç”±è¨˜è¿°', pl.subitem_geolocation_place_text || '', 'text', null, { fieldKey: 'subitem_geolocation_place_text' }));
    grp.appendChild(delBtn);
    plCont.appendChild(grp);
  });
  geoCont.appendChild(plWrap);

  return geoItem;
}

// ----- ä½ç½®æƒ…å ± -----
function renderGeolocationField(def, geos) {
  const arr = Array.isArray(geos) ? geos : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  arr.forEach((geo, idx) => {
    content.appendChild(renderOneGeolocation(geo, idx, def.label));
  });

  content.appendChild(createAddButton(def.label, () => {
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const emptyGeo = {
      subitem_geolocation_point: { subitem_point_longitude: '', subitem_point_latitude: '' },
      subitem_geolocation_box: { subitem_west_longitude: '', subitem_east_longitude: '', subitem_south_latitude: '', subitem_north_latitude: '' },
      subitem_geolocation_place: [],
    };
    content.insertBefore(renderOneGeolocation(emptyGeo, idx, def.label), content.lastChild);
  }));
  return section;
}

// ----- ä¼šè­°è¨˜è¿°: 1ä»¶åˆ†ã®DOMç”Ÿæˆ -----
function renderOneConference(conf, idx, defLabel) {
  const confName = conf.subitem_conference_names?.[0]?.subitem_conference_name || '';
  const itemLabel = `${defLabel}[${idx}]${confName ? ': '+confName.substring(0,40) : ''}`;
  const { item: confItem, content: confCont } = createNestedItem(itemLabel, 1);

  // ä¼šè­°åï¼ˆé…åˆ—ï¼‰
  const { wrapper: cnWrap, content: cnCont } = createNestedSectionHeader('ä¼šè­°å', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('ä¼šè­°å', '', 'text', null, { fieldKey: 'subitem_conference_name' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_conference_name_language' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (conf.subitem_conference_names || []).forEach(cn => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('ä¼šè­°å', cn.subitem_conference_name || '', 'text', null, { fieldKey: 'subitem_conference_name' }));
    grp.appendChild(createFieldRow('è¨€èª', cn.subitem_conference_name_language || '', 'select', 'language', { fieldKey: 'subitem_conference_name_language' }));
    grp.appendChild(delBtn);
    cnCont.appendChild(grp);
  });
  confCont.appendChild(cnWrap);

  // å›æ¬¡
  confCont.appendChild(createFieldRow('å›æ¬¡', conf.subitem_conference_sequence || '', 'text', null, { fieldKey: 'subitem_conference_sequence' }));

  // ä¸»å‚¬æ©Ÿé–¢ï¼ˆé…åˆ—ï¼‰
  const { wrapper: csWrap, content: csCont } = createNestedSectionHeader('ä¸»å‚¬æ©Ÿé–¢', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('ä¸»å‚¬æ©Ÿé–¢', '', 'text', null, { fieldKey: 'subitem_conference_sponsor' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_conference_sponsor_language' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (conf.subitem_conference_sponsors || []).forEach(cs => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('ä¸»å‚¬æ©Ÿé–¢', cs.subitem_conference_sponsor || '', 'text', null, { fieldKey: 'subitem_conference_sponsor' }));
    grp.appendChild(createFieldRow('è¨€èª', cs.subitem_conference_sponsor_language || '', 'select', 'language', { fieldKey: 'subitem_conference_sponsor_language' }));
    grp.appendChild(delBtn);
    csCont.appendChild(grp);
  });
  confCont.appendChild(csWrap);

  // é–‹å‚¬æœŸé–“ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  const cd = conf.subitem_conference_date || {};
  const { wrapper: cdWrap, content: cdCont } = createNestedSectionHeader('é–‹å‚¬æœŸé–“', 2, false);
  cdCont.appendChild(createFieldRow('é–‹å§‹å¹´', cd.subitem_conference_start_year || '', 'text', null, { fieldKey: 'subitem_conference_start_year' }));
  cdCont.appendChild(createFieldRow('é–‹å§‹æœˆ', cd.subitem_conference_start_month || '', 'text', null, { fieldKey: 'subitem_conference_start_month' }));
  cdCont.appendChild(createFieldRow('é–‹å§‹æ—¥', cd.subitem_conference_start_day || '', 'text', null, { fieldKey: 'subitem_conference_start_day' }));
  cdCont.appendChild(createFieldRow('çµ‚äº†å¹´', cd.subitem_conference_end_year || '', 'text', null, { fieldKey: 'subitem_conference_end_year' }));
  cdCont.appendChild(createFieldRow('çµ‚äº†æœˆ', cd.subitem_conference_end_month || '', 'text', null, { fieldKey: 'subitem_conference_end_month' }));
  cdCont.appendChild(createFieldRow('çµ‚äº†æ—¥', cd.subitem_conference_end_day || '', 'text', null, { fieldKey: 'subitem_conference_end_day' }));
  cdCont.appendChild(createFieldRow('é–‹å‚¬æœŸé–“', cd.subitem_conference_period || '', 'text', null, { fieldKey: 'subitem_conference_period' }));
  cdCont.appendChild(createFieldRow('è¨€èª', cd.subitem_conference_date_language || '', 'select', 'language', { fieldKey: 'subitem_conference_date_language' }));
  confCont.appendChild(cdWrap);

  // é–‹å‚¬ä¼šå ´ï¼ˆé…åˆ—ï¼‰
  const { wrapper: cvWrap, content: cvCont } = createNestedSectionHeader('é–‹å‚¬ä¼šå ´', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('é–‹å‚¬ä¼šå ´', '', 'text', null, { fieldKey: 'subitem_conference_venue' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_conference_venue_language' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (conf.subitem_conference_venues || []).forEach(cv => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('é–‹å‚¬ä¼šå ´', cv.subitem_conference_venue || '', 'text', null, { fieldKey: 'subitem_conference_venue' }));
    grp.appendChild(createFieldRow('è¨€èª', cv.subitem_conference_venue_language || '', 'select', 'language', { fieldKey: 'subitem_conference_venue_language' }));
    grp.appendChild(delBtn);
    cvCont.appendChild(grp);
  });
  confCont.appendChild(cvWrap);

  // é–‹å‚¬åœ°ï¼ˆé…åˆ—ï¼‰
  const { wrapper: cpWrap, content: cpCont } = createNestedSectionHeader('é–‹å‚¬åœ°', 2, (cont) => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('é–‹å‚¬åœ°', '', 'text', null, { fieldKey: 'subitem_conference_place' }));
    grp.appendChild(createFieldRow('è¨€èª', '', 'select', 'language', { fieldKey: 'subitem_conference_place_language' }));
    grp.appendChild(delBtn);
    cont.appendChild(grp);
  });
  (conf.subitem_conference_places || []).forEach(cp => {
    const { grp, delBtn } = createEntryGroup();
    grp.appendChild(createFieldRow('é–‹å‚¬åœ°', cp.subitem_conference_place || '', 'text', null, { fieldKey: 'subitem_conference_place' }));
    grp.appendChild(createFieldRow('è¨€èª', cp.subitem_conference_place_language || '', 'select', 'language', { fieldKey: 'subitem_conference_place_language' }));
    grp.appendChild(delBtn);
    cpCont.appendChild(grp);
  });
  confCont.appendChild(cpWrap);

  // é–‹å‚¬å›½
  confCont.appendChild(createFieldRow('é–‹å‚¬å›½', conf.subitem_conference_country || '', 'select', 'subitem_conference_country', { fieldKey: 'subitem_conference_country' }));

  return confItem;
}

// ----- ä¼šè­°è¨˜è¿° -----
function renderConferenceField(def, confs) {
  const arr = Array.isArray(confs) ? confs : [];
  const summaryText = def.sum(arr);
  const { section, content } = createSection(def.key, def.label, summaryText);

  arr.forEach((conf, idx) => {
    content.appendChild(renderOneConference(conf, idx, def.label));
  });

  content.appendChild(createAddButton(def.label, () => {
    const idx = content.querySelectorAll(':scope > .nested-item').length;
    const emptyConf = {
      subitem_conference_names: [{ subitem_conference_name: '', subitem_conference_name_language: '' }],
      subitem_conference_sequence: '',
      subitem_conference_sponsors: [],
      subitem_conference_date: {},
      subitem_conference_venues: [],
      subitem_conference_places: [],
      subitem_conference_country: '',
    };
    content.insertBefore(renderOneConference(emptyConf, idx, def.label), content.lastChild);
  }));
  return section;
}

// ===== 5.5 ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
function renderAll(metadata) {
  const container = document.getElementById('metadata-fields');
  container.innerHTML = '';

  // ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  renderSystemFields(metadata.system);

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  for (const def of FIELD_DEFS) {
    const value = metadata[def.key];
    if (value === undefined) continue;
    let sectionEl;
    switch (def.type) {
      case 'array':
        sectionEl = renderArrayField(def, value);
        break;
      case 'object':
        sectionEl = renderObjectField(def, value);
        break;
      case 'creator':
        sectionEl = renderPersonField(def, value, true);
        break;
      case 'contributor':
        sectionEl = renderPersonField(def, value, false);
        break;
      case 'relation':
        sectionEl = renderRelationField(def, value);
        break;
      case 'funding':
        sectionEl = renderFundingField(def, value);
        break;
      case 'biblio':
        sectionEl = renderBiblioField(def, value);
        break;
      case 'rightsHolder':
        sectionEl = renderRightsHolderField(def, value);
        break;
      case 'geolocation':
        sectionEl = renderGeolocationField(def, value);
        break;
      case 'conference':
        sectionEl = renderConferenceField(def, value);
        break;
      default:
        continue;
    }
    container.appendChild(sectionEl);
  }

  document.getElementById('preview-area').style.display = 'block';
}

// ===== 5.6 ç©ºãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ =====
function buildEmptyMetadata() {
  return {
    system: {
      id: '', uri: '', path: '',
      pos_index: document.getElementById('pos-index-input').value,
      publish_status: 'private', feedback_mail: '', cnri: '',
      doi_ra: '', doi: '', edit_mode: 'Keep', pubdate: todayStr(),
    },
    item_30002_title0: [{ subitem_title: '', subitem_title_language: '' }],
    item_30002_alternative_title1: [],
    item_30002_creator2: [{
      creatorType: '', creatorNames: [{ creatorName: '', creatorNameLang: '', creatorNameType: '' }],
      familyNames: [{ familyName: '', familyNameLang: '' }],
      givenNames: [{ givenName: '', givenNameLang: '' }],
      nameIdentifiers: [{ nameIdentifier: '', nameIdentifierScheme: '', nameIdentifierURI: '' }],
      creatorAffiliations: [{
        affiliationNames: [{ affiliationName: '', affiliationNameLang: '' }],
        affiliationNameIdentifiers: [{ affiliationNameIdentifier: '', affiliationNameIdentifierScheme: '', affiliationNameIdentifierURI: '' }],
      }],
    }],
    item_30002_contributor3: [],
    item_30002_access_rights4: { subitem_access_right: '', subitem_access_right_uri: '' },
    item_30002_rights6: [],
    item_30002_rights_holder7: [{
      rightHolderNames: [{ rightHolderName: '', rightHolderLanguage: '' }],
      nameIdentifiers: [],
    }],
    item_30002_subject8: [],
    item_30002_description9: [],
    item_30002_publisher10: [],
    item_30002_date11: [],
    item_30002_language12: [{ subitem_language: '' }],
    item_30002_resource_type13: { resourcetype: '', resourceuri: '' },
    item_30002_version14: { subitem_version: '' },
    item_30002_version_type15: { subitem_version_resource: '', subitem_version_type: '' },
    item_30002_identifier16: [],
    item_30002_identifier_registration17: { subitem_identifier_reg_text: '', subitem_identifier_reg_type: '' },
    item_30002_relation18: [],
    item_30002_temporal19: [],
    item_30002_geolocation20: [{
      subitem_geolocation_point: { subitem_point_longitude: '', subitem_point_latitude: '' },
      subitem_geolocation_box: { subitem_west_longitude: '', subitem_east_longitude: '', subitem_south_latitude: '', subitem_north_latitude: '' },
      subitem_geolocation_place: [{ subitem_geolocation_place_text: '' }],
    }],
    item_30002_funding_reference21: [],
    item_30002_source_identifier22: [],
    item_30002_source_title23: [],
    item_30002_volume_number24: { subitem_volume: '' },
    item_30002_issue_number25: { subitem_issue: '' },
    item_30002_number_of_pages26: { subitem_number_of_pages: '' },
    item_30002_page_start27: { subitem_start_page: '' },
    item_30002_page_end28: { subitem_end_page: '' },
    item_30002_bibliographic_information29: null,
    item_30002_conference34: [{
      subitem_conference_names: [{ subitem_conference_name: '', subitem_conference_name_language: '' }],
      subitem_conference_sequence: '',
      subitem_conference_sponsors: [],
      subitem_conference_date: {},
      subitem_conference_venues: [],
      subitem_conference_places: [],
      subitem_conference_country: '',
    }],
  };
}

// ===== Enter ã‚­ãƒ¼ =====
document.getElementById('doi-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') fetchData();
});

// ===== APIã‚­ãƒ¼æœªè¨­å®šè­¦å‘Š =====
if (!CONFIG.OpenAlex_API_KEY || CONFIG.OpenAlex_API_KEY === 'YOUR_OpenAlex_API_KEY') {
  document.getElementById('apikey-warning').style.display = 'block';
}
</script>
</body>
</html>
